<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="福祉用具計算">
<meta name="theme-color" content="#2563eb">
<title>福祉用具点数計算アプリ</title>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js';
  import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, writeBatch } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js';
  
  // Firebase設定
  const firebaseConfig = {
    apiKey: "AIzaSyCsKv9UDALkSle0CJ4Ag8pxgisWDbdznnI",
    authDomain: "find-assistive-devices-apps.firebaseapp.com",
    projectId: "find-assistive-devices-apps",
    storageBucket: "find-assistive-devices-apps.firebasestorage.app",
    messagingSenderId: "474642604597",
    appId: "1:474642604597:web:5b353b489bac360ba7477c"
  };

  // Firebase 初期化
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  
  // グローバルスコープに公開
  window.db = db;
  window.firestore = { collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, writeBatch };
</script>

<style>
:root {
  --primary-color: #2563eb;
  --primary-dark: #1d4ed8;
  --success-color: #10b981;
  --danger-color: #ef4444;
  --warning-color: #f59e0b;
  --text-primary: #1e293b;
  --text-secondary: #6b7280;
  --bg-white: rgba(255, 255, 255, 0.95);
  --safe-area-top: env(safe-area-inset-top, 0);
  --safe-area-bottom: env(safe-area-inset-bottom, 0);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  min-height: -webkit-fill-available;
  padding-top: var(--safe-area-top);
  padding-bottom: var(--safe-area-bottom);
  overflow-x: hidden;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 12px;
  min-height: 100vh;
  min-height: -webkit-fill-available;
  display: flex;
  flex-direction: column;
}

/* ヘッダー */
.header {
  background: var(--bg-white);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 12px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.title {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 12px;
  text-align: center;
}

/* モード切り替え */
.mode-toggle {
  display: flex;
  gap: 4px;
  background: rgba(0, 0, 0, 0.05);
  border-radius: 10px;
  padding: 3px;
  margin-bottom: 12px;
}

.mode-btn {
  flex: 1;
  background: transparent;
  color: var(--text-secondary);
  border: none;
  padding: 10px 12px;
  border-radius: 7px;
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
  transition: all 0.2s ease;
  touch-action: manipulation;
}

.mode-btn.active {
  background: white;
  color: var(--text-primary);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* 検索入力 */
.search-container {
  position: relative;
  margin-bottom: 12px;
}

.search-wrapper {
  position: relative;
}

.search-icon {
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-secondary);
  pointer-events: none;
}

.search-input {
  width: 100%;
  padding: 14px 44px 14px 44px;
  border: none;
  border-radius: 12px;
  background: white;
  font-size: 16px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  transition: all 0.2s ease;
}

.search-input:focus {
  outline: none;
  box-shadow: 0 4px 16px rgba(37, 99, 235, 0.2);
}

.clear-search {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--text-secondary);
  color: white;
  border: none;
  cursor: pointer;
  display: none;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  touch-action: manipulation;
}

.clear-search.show {
  display: flex;
}

/* 管理者パネル */
.admin-panel {
  display: none;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  border: 2px dashed rgba(255, 255, 255, 0.3);
}

.admin-panel.active {
  display: block;
}

.file-upload-container {
  padding: 20px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  border: 2px dashed rgba(255, 255, 255, 0.3);
  text-align: center;
  margin-bottom: 16px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.file-upload-container:hover,
.file-upload-container.drag-over {
  border-color: rgba(255, 255, 255, 0.5);
  background: rgba(255, 255, 255, 0.15);
}

.file-input {
  display: none;
}

.file-upload-btn {
  background: linear-gradient(45deg, var(--success-color), #059669);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  margin-bottom: 8px;
  touch-action: manipulation;
}

.file-upload-text {
  color: rgba(255, 255, 255, 0.8);
  font-size: 13px;
  margin-top: 8px;
}

.manual-add {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
}

.input-group {
  display: flex;
  flex-direction: column;
}

.input-label {
  color: rgba(255, 255, 255, 0.9);
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 6px;
}

.manual-input {
  padding: 12px 16px;
  border: none;
  border-radius: 8px;
  background: white;
  font-size: 15px;
}

.add-manual-btn {
  background: linear-gradient(45deg, var(--primary-color), var(--primary-dark));
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  width: 100%;
  touch-action: manipulation;
}

/* ステータスメッセージ */
.status-message {
  margin-top: 12px;
  padding: 10px 16px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.status-success {
  background: #dcfce7;
  color: #166534;
}

.status-error {
  background: #fecaca;
  color: #991b1b;
}

.status-info {
  background: #dbeafe;
  color: #1e40af;
}

/* メインコンテンツ */
.main-content {
  display: flex;
  flex-direction: column;
  flex: 1;
  gap: 12px;
}

/* 検索結果 */
.search-results {
  background: var(--bg-white);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  min-height: calc(100vh - 250px);
}

.result-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px;
  background: white;
  border-radius: 12px;
  margin-bottom: 10px;
  transition: all 0.2s ease;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.result-item:active {
  transform: scale(0.98);
}

.item-info {
  flex: 1;
  min-width: 0;
}

.item-name {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 4px;
  font-size: 15px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.item-points {
  color: var(--text-secondary);
  font-size: 13px;
}

.item-actions {
  display: flex;
  gap: 6px;
  align-items: center;
  flex-shrink: 0;
}

.add-btn, .edit-btn, .delete-btn {
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  font-size: 12px;
  transition: all 0.2s ease;
  white-space: nowrap;
  touch-action: manipulation;
}

.add-btn {
  background: linear-gradient(45deg, var(--success-color), #059669);
  color: white;
}

.add-btn:active {
  transform: scale(0.95);
}

.add-btn.added {
  background: linear-gradient(45deg, #6b7280, #4b5563);
}

.edit-btn {
  background: linear-gradient(45deg, var(--warning-color), #d97706);
  color: white;
  padding: 6px 10px;
}

.delete-btn {
  background: linear-gradient(45deg, var(--danger-color), #dc2626);
  color: white;
  padding: 6px 10px;
}

/* 計算機 */
.mobile-toggle {
  display: block;
  background: linear-gradient(45deg, var(--primary-color), var(--primary-dark));
  color: white;
  border: none;
  padding: 14px 20px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  font-size: 15px;
  box-shadow: 0 4px 16px rgba(37, 99, 235, 0.3);
  position: sticky;
  top: 10px;
  z-index: 10;
  touch-action: manipulation;
}

.mobile-toggle:active {
  transform: scale(0.98);
}

.mobile-count {
  background: white;
  color: var(--primary-color);
  padding: 2px 8px;
  border-radius: 12px;
  margin-left: 8px;
  font-weight: 700;
}

.calculator {
  display: none;
}

.calculator.show {
  display: flex;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--bg-white);
  z-index: 100;
  flex-direction: column;
  padding: var(--safe-area-top) 16px var(--safe-area-bottom) 16px;
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from {
    transform: translateY(100%);
  }
  to {
    transform: translateY(0);
  }
}

.calculator-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.calculator-title {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 12px;
}

.total-points {
  background: linear-gradient(45deg, var(--primary-color), var(--primary-dark));
  color: white;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 15px;
}

.close-btn {
  background: var(--text-secondary);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  touch-action: manipulation;
}

.selected-items {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  margin-bottom: 16px;
}

.selected-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px;
  background: white;
  border-radius: 12px;
  margin-bottom: 10px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.selected-item-info {
  flex: 1;
  min-width: 0;
}

.selected-item-name {
  font-weight: 600;
  color: var(--text-primary);
  font-size: 14px;
  margin-bottom: 4px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.selected-item-points {
  color: var(--text-secondary);
  font-size: 12px;
}

.quantity-controls {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-right: 8px;
}

.quantity-btn {
  background: #e5e7eb;
  color: #374151;
  border: none;
  width: 32px;
  height: 32px;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: bold;
  transition: all 0.2s ease;
  touch-action: manipulation;
}

.quantity-btn:active:not(:disabled) {
  transform: scale(0.9);
}

.quantity-btn:disabled {
  background: #f3f4f6;
  color: #9ca3af;
  cursor: not-allowed;
}

.quantity-display {
  background: #f8fafc;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 700;
  color: var(--text-primary);
  min-width: 30px;
  text-align: center;
}

.remove-btn {
  background: var(--danger-color);
  color: white;
  border: none;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  transition: all 0.2s ease;
  touch-action: manipulation;
}

.remove-btn:active {
  transform: scale(0.9);
}

.clear-btn {
  width: 100%;
  background: var(--text-secondary);
  color: white;
  border: none;
  padding: 14px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  font-size: 15px;
  transition: all 0.2s ease;
  touch-action: manipulation;
}

.clear-btn:active {
  transform: scale(0.98);
}

/* 空状態 */
.empty-state {
  text-align: center;
  padding: 40px 20px;
}

.empty-state h3 {
  color: var(--text-primary);
  font-size: 16px;
  margin-bottom: 8px;
}

.empty-state p {
  color: var(--text-secondary);
  font-size: 14px;
}

/* ローディング */
.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 40px;
  color: var(--text-secondary);
}

.spinner {
  width: 24px;
  height: 24px;
  border: 3px solid #e5e7eb;
  border-top: 3px solid var(--primary-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* デスクトップ向け調整 */
@media (min-width: 768px) {
  .container {
    padding: 20px;
  }

  .header {
    padding: 24px;
    margin-bottom: 20px;
  }

  .title {
    font-size: 28px;
    margin-bottom: 20px;
  }

  .main-content {
    flex-direction: row;
    gap: 20px;
  }

  .search-results {
    flex: 1;
    max-height: calc(100vh - 220px);
  }

  .mobile-toggle {
    display: none;
  }

  .calculator {
    display: flex;
    position: sticky;
    top: 20px;
    width: 400px;
    background: var(--bg-white);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    max-height: calc(100vh - 40px);
    animation: none;
  }

  .calculator.show {
    position: sticky;
  }

  .close-btn {
    display: none;
  }

  .manual-add {
    grid-template-columns: 2fr 1fr auto;
    align-items: end;
  }

  .add-manual-btn {
    width: auto;
    height: fit-content;
  }
}

/* アクセシビリティ */
.visually-hidden {
  position: absolute;
  width: 1px;
  height: 1px;
  margin: -1px;
  padding: 0;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* フォーカス表示 */
button:focus-visible,
input:focus-visible {
  outline: 3px solid var(--primary-color);
  outline-offset: 2px;
}

/* ダークモード対応 */
@media (prefers-color-scheme: dark) {
  :root {
    --bg-white: rgba(30, 30, 30, 0.95);
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
  }
  
  .search-input,
  .manual-input,
  .result-item,
  .selected-item {
    background: rgba(50, 50, 50, 0.9);
    color: var(--text-primary);
  }
  
  .mode-btn.active {
    background: rgba(60, 60, 60, 0.9);
  }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1 class="title">福祉用具点数計算アプリ</h1>
    
    <div class="mode-toggle" role="tablist">
      <button class="mode-btn active" id="userMode" role="tab" aria-selected="true" aria-controls="search-panel">
        利用者モード
      </button>
      <button class="mode-btn" id="adminMode" role="tab" aria-selected="false" aria-controls="admin-panel">
        管理者モード
      </button>
    </div>
    
    <div class="admin-panel" id="adminPanel" role="tabpanel" aria-hidden="true">
      <div class="upload-section">
        <div class="file-upload-container" id="dropZone">
          <input type="file" class="file-input" id="fileInput" accept=".xlsx,.xls" aria-label="Excelファイルを選択">
          <button class="file-upload-btn" onclick="document.getElementById('fileInput').click()">
            📁 Excelファイルをアップロード
          </button>
          <div class="file-upload-text">
            ドラッグ&ドロップまたはクリックして選択<br>
            (A列：商品名、B列：点数)
          </div>
        </div>
        
        <div class="manual-add">
          <div class="input-group">
            <label class="input-label" for="manualName">商品名</label>
            <input type="text" class="manual-input" id="manualName" placeholder="例：車いす">
          </div>
          <div class="input-group">
            <label class="input-label" for="manualPoints">点数/月</label>
            <input type="number" class="manual-input" id="manualPoints" placeholder="例：400" min="1">
          </div>
          <button class="add-manual-btn" id="addManualBtn">➕ 手動追加</button>
        </div>
        
        <div id="adminStatus" role="status" aria-live="polite"></div>
      </div>
    </div>
    
    <div class="search-container" id="search-panel" role="tabpanel">
      <div class="search-wrapper">
        <span class="search-icon">🔍</span>
        <input 
          type="search" 
          class="search-input" 
          id="searchInput" 
          placeholder="福祉用具を検索..."
          aria-label="福祉用具を検索"
          autocomplete="off"
        >
        <button class="clear-search" id="clearSearchBtn" aria-label="検索をクリア">✕</button>
      </div>
    </div>
  </div>
  
  <button class="mobile-toggle" id="toggleCalculator">
    📊 計算結果を表示
    <span class="mobile-count" id="mobileCount">0</span>
  </button>
  
  <div class="main-content">
    <div class="search-results" id="searchResults" role="region" aria-label="検索結果">
      <div class="loading">
        <div class="spinner"></div>
        <span>データを読み込み中...</span>
      </div>
    </div>
    
    <div class="calculator" id="calculator" role="region" aria-label="選択した品目">
      <div class="calculator-header">
        <div class="calculator-title">
          選択した品目
          <span class="total-points" id="totalPoints">0点</span>
        </div>
        <button class="close-btn" id="closeCalculator">✕ 閉じる</button>
      </div>
      <div class="selected-items" id="selectedItems">
        <div class="empty-state">
          <h3>📦 品目が選択されていません</h3>
          <p>左側のリストから品目を追加してください</p>
        </div>
      </div>
      <button class="clear-btn" id="clearAll">🗑️ 全て削除</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// アプリケーション状態管理
const AppState = {
  welfareEquipment: [],
  selectedItems: [],
  filteredItems: [],
  isAdminMode: false,
  searchQuery: '',
  isLoading: false,
  debounceTimer: null
};

// DOM要素のキャッシュ
const DOM = {
  init() {
    this.userModeBtn = document.getElementById('userMode');
    this.adminModeBtn = document.getElementById('adminMode');
    this.adminPanel = document.getElementById('adminPanel');
    this.fileInput = document.getElementById('fileInput');
    this.dropZone = document.getElementById('dropZone');
    this.manualName = document.getElementById('manualName');
    this.manualPoints = document.getElementById('manualPoints');
    this.addManualBtn = document.getElementById('addManualBtn');
    this.adminStatus = document.getElementById('adminStatus');
    this.searchInput = document.getElementById('searchInput');
    this.clearSearchBtn = document.getElementById('clearSearchBtn');
    this.searchResults = document.getElementById('searchResults');
    this.selectedItemsContainer = document.getElementById('selectedItems');
    this.totalPointsElement = document.getElementById('totalPoints');
    this.clearAllBtn = document.getElementById('clearAll');
    this.toggleCalculatorBtn = document.getElementById('toggleCalculator');
    this.calculator = document.getElementById('calculator');
    this.closeCalculatorBtn = document.getElementById('closeCalculator');
    this.mobileCountSpan = document.getElementById('mobileCount');
  }
};

// Firebase データベース操作
const FirebaseDB = {
  async loadEquipment() {
    try {
      const q = window.firestore.query(
        window.firestore.collection(window.db, 'welfare_equipment'),
        window.firestore.orderBy('name')
      );
      const querySnapshot = await window.firestore.getDocs(q);
      const equipment = [];
      querySnapshot.forEach((doc) => {
        equipment.push({
          id: doc.id,
          ...doc.data()
        });
      });
      return equipment;
    } catch (error) {
      console.error('データ読み込みエラー:', error);
      throw error;
    }
  },

  async addEquipment(name, points) {
    try {
      const docRef = await window.firestore.addDoc(
        window.firestore.collection(window.db, 'welfare_equipment'),
        {
          name: name.trim(),
          points: parseInt(points),
          createdAt: new Date()
        }
      );
      return docRef.id;
    } catch (error) {
      console.error('データ追加エラー:', error);
      throw error;
    }
  },

  async addBatchEquipment(items) {
    try {
      const batch = window.firestore.writeBatch(window.db);
      const collectionRef = window.firestore.collection(window.db, 'welfare_equipment');
      
      items.forEach(item => {
        const docRef = window.firestore.doc(collectionRef);
        batch.set(docRef, {
          name: item.name,
          points: item.points,
          createdAt: new Date()
        });
      });
      
      await batch.commit();
      return items.length;
    } catch (error) {
      console.error('バッチ追加エラー:', error);
      throw error;
    }
  },

  async updateEquipment(id, name, points) {
    try {
      await window.firestore.updateDoc(
        window.firestore.doc(window.db, 'welfare_equipment', id),
        {
          name: name.trim(),
          points: parseInt(points),
          updatedAt: new Date()
        }
      );
    } catch (error) {
      console.error('データ更新エラー:', error);
      throw error;
    }
  },

  async deleteEquipment(id) {
    try {
      await window.firestore.deleteDoc(
        window.firestore.doc(window.db, 'welfare_equipment', id)
      );
    } catch (error) {
      console.error('データ削除エラー:', error);
      throw error;
    }
  }
};

// ユーティリティ関数
const Utils = {
  debounce(func, wait) {
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(AppState.debounceTimer);
        func(...args);
      };
      clearTimeout(AppState.debounceTimer);
      AppState.debounceTimer = setTimeout(later, wait);
    };
  },

  formatNumber(num) {
    return num.toLocaleString('ja-JP');
  },

  showMessage(message, type = 'info') {
    const statusElement = DOM.adminStatus;
    statusElement.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
    
    const duration = type === 'error' ? 8000 : type === 'success' ? 5000 : 3000;
    setTimeout(() => {
      statusElement.innerHTML = '';
    }, duration);
  },

  saveToStorage(key, data) {
    try {
      sessionStorage.setItem(key, JSON.stringify(data));
    } catch (error) {
      console.error('ストレージ保存エラー:', error);
    }
  },

  loadFromStorage(key) {
    try {
      const data = sessionStorage.getItem(key);
      return data ? JSON.parse(data) : null;
    } catch (error) {
      console.error('ストレージ読み込みエラー:', error);
      return null;
    }
  }
};

// UI管理
const UI = {
  updateSearchResults(items) {
    if (items.length === 0) {
      DOM.searchResults.innerHTML = `
        <div class="empty-state">
          <h3>🔍 該当する品目が見つかりません</h3>
          <p>別のキーワードで検索してみてください</p>
        </div>
      `;
      return;
    }

    const html = items.map(item => {
      const selectedItem = AppState.selectedItems.find(s => s.id === item.id);
      const isSelected = !!selectedItem;
      const quantity = selectedItem ? selectedItem.quantity : 0;

      const adminButtons = AppState.isAdminMode ? `
        <button class="edit-btn" onclick="App.editItem('${item.id}', '${item.name.replace(/'/g, "\\'")}', ${item.points})" aria-label="編集">
          ✏️
        </button>
        <button class="delete-btn" onclick="App.deleteItem('${item.id}', '${item.name.replace(/'/g, "\\'")}') aria-label="削除">
          🗑️
        </button>
      ` : '';

      return `
        <div class="result-item">
          <div class="item-info">
            <div class="item-name">${item.name}</div>
            <div class="item-points">${Utils.formatNumber(item.points)}点/月</div>
          </div>
          <div class="item-actions">
            <button 
              class="add-btn ${isSelected ? 'added' : ''}" 
              onclick="App.addItem('${item.id}')"
              aria-label="${isSelected ? `追加済み (${quantity}個)` : '追加'}"
            >
              ${isSelected ? `✓ ${quantity}個` : '＋ 追加'}
            </button>
            ${adminButtons}
          </div>
        </div>
      `;
    }).join('');

    DOM.searchResults.innerHTML = html;
  },

  updateCalculator() {
    const totalPoints = AppState.selectedItems.reduce((sum, item) => 
      sum + (item.points * item.quantity), 0
    );
    
    DOM.totalPointsElement.textContent = `${Utils.formatNumber(totalPoints)}点`;

    if (AppState.selectedItems.length === 0) {
      DOM.selectedItemsContainer.innerHTML = `
        <div class="empty-state">
          <h3>📦 品目が選択されていません</h3>
          <p>左側のリストから品目を追加してください</p>
        </div>
      `;
    } else {
      const html = AppState.selectedItems.map(item => `
        <div class="selected-item">
          <div class="selected-item-info">
            <div class="selected-item-name">${item.name}</div>
            <div class="selected-item-points">
              ${Utils.formatNumber(item.points)}点 × ${item.quantity} = ${Utils.formatNumber(item.points * item.quantity)}点
            </div>
          </div>
          <div class="quantity-controls">
            <button 
              class="quantity-btn" 
              onclick="App.updateQuantity('${item.id}', -1)" 
              ${item.quantity <= 1 ? 'disabled' : ''}
              aria-label="数量を減らす"
            >
              －
            </button>
            <div class="quantity-display">${item.quantity}</div>
            <button 
              class="quantity-btn" 
              onclick="App.updateQuantity('${item.id}', 1)"
              aria-label="数量を増やす"
            >
              ＋
            </button>
          </div>
          <button 
            class="remove-btn" 
            onclick="App.removeItem('${item.id}')"
            aria-label="削除"
          >
            ✕
          </button>
        </div>
      `).join('');

      DOM.selectedItemsContainer.innerHTML = html;
    }

    this.updateMobileCount();
  },

  updateMobileCount() {
    const totalItems = AppState.selectedItems.reduce((sum, item) => sum + item.quantity, 0);
    DOM.mobileCountSpan.textContent = totalItems;
  },

  showEmptySearchState() {
    DOM.searchResults.innerHTML = `
      <div class="empty-state">
        <h3>🔎 福祉用具を検索してください</h3>
        <p>品目名を入力すると検索結果が表示されます</p>
      </div>
    `;
  },

  showLoadingState() {
    DOM.searchResults.innerHTML = `
      <div class="loading">
        <div class="spinner"></div>
        <span>データを読み込み中...</span>
      </div>
    `;
  }
};

// メインアプリケーション
const App = {
  async init() {
    DOM.init();
    this.attachEventListeners();
    
    try {
      UI.showLoadingState();
      await this.loadEquipmentData();
      this.loadSelectedItems();
      UI.showEmptySearchState();
    } catch (error) {
      Utils.showMessage('データベース接続エラーが発生しました。ページを再読み込みしてください。', 'error');
    }
  },

  attachEventListeners() {
    // モード切り替え
    DOM.userModeBtn.addEventListener('click', () => this.switchMode(false));
    DOM.adminModeBtn.addEventListener('click', () => this.switchMode(true));

    // 検索
    const debouncedSearch = Utils.debounce((query) => this.performSearch(query), 300);
    DOM.searchInput.addEventListener('input', (e) => {
      AppState.searchQuery = e.target.value.trim();
      DOM.clearSearchBtn.classList.toggle('show', AppState.searchQuery.length > 0);
      
      if (AppState.searchQuery === '') {
        UI.showEmptySearchState();
      } else {
        debouncedSearch(AppState.searchQuery);
      }
    });

    // 検索クリア
    DOM.clearSearchBtn.addEventListener('click', () => {
      DOM.searchInput.value = '';
      AppState.searchQuery = '';
      DOM.clearSearchBtn.classList.remove('show');
      UI.showEmptySearchState();
    });

    // ファイルアップロード
    DOM.fileInput.addEventListener('change', (e) => this.handleFileUpload(e));

    // ドラッグ&ドロップ
    DOM.dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      DOM.dropZone.classList.add('drag-over');
    });

    DOM.dropZone.addEventListener('dragleave', () => {
      DOM.dropZone.classList.remove('drag-over');
    });

    DOM.dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      DOM.dropZone.classList.remove('drag-over');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        DOM.fileInput.files = files;
        this.handleFileUpload({ target: { files } });
      }
    });

    // 手動追加
    DOM.addManualBtn.addEventListener('click', () => this.handleManualAdd());
    
    // Enterキーで追加
    DOM.manualName.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') DOM.manualPoints.focus();
    });
    
    DOM.manualPoints.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') this.handleManualAdd();
    });

    // 計算機表示切り替え（モバイル）
    DOM.toggleCalculatorBtn.addEventListener('click', () => {
      DOM.calculator.classList.add('show');
    });

    DOM.closeCalculatorBtn.addEventListener('click', () => {
      DOM.calculator.classList.remove('show');
    });

    // 全削除
    DOM.clearAllBtn.addEventListener('click', () => {
      if (AppState.selectedItems.length > 0 && confirm('選択した品目を全て削除しますか？')) {
        AppState.selectedItems = [];
        UI.updateCalculator();
        this.saveSelectedItems();
        this.performSearch(AppState.searchQuery);
      }
    });

    // ウィンドウリサイズ対応
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        if (window.innerWidth >= 768) {
          DOM.calculator.classList.remove('show');
        }
      }, 250);
    });
  },

  async loadEquipmentData() {
    try {
      AppState.welfareEquipment = await FirebaseDB.loadEquipment();
      AppState.filteredItems = AppState.welfareEquipment;
      
      if (AppState.welfareEquipment.length > 0) {
        Utils.showMessage(`${AppState.welfareEquipment.length}件のデータを読み込みました`, 'info');
      }
    } catch (error) {
      throw error;
    }
  },

  loadSelectedItems() {
    const saved = Utils.loadFromStorage('selectedWelfareItems');
    if (saved) {
      AppState.selectedItems = saved;
      UI.updateCalculator();
    }
  },

  saveSelectedItems() {
    Utils.saveToStorage('selectedWelfareItems', AppState.selectedItems);
  },

  switchMode(isAdmin) {
    AppState.isAdminMode = isAdmin;
    DOM.userModeBtn.classList.toggle('active', !isAdmin);
    DOM.adminModeBtn.classList.toggle('active', isAdmin);
    DOM.adminPanel.classList.toggle('active', isAdmin);
    DOM.adminPanel.setAttribute('aria-hidden', !isAdmin);
    DOM.userModeBtn.setAttribute('aria-selected', !isAdmin);
    DOM.adminModeBtn.setAttribute('aria-selected', isAdmin);

    if (AppState.searchQuery) {
      this.performSearch(AppState.searchQuery);
    }
  },

  performSearch(query) {
    if (AppState.welfareEquipment.length === 0) {
      DOM.searchResults.innerHTML = `
        <div class="empty-state">
          <h3>📋 データがありません</h3>
          <p>管理者モードでデータを追加してください</p>
        </div>
      `;
      return;
    }

    AppState.filteredItems = AppState.welfareEquipment.filter(item => 
      item.name.toLowerCase().includes(query.toLowerCase())
    );

    UI.updateSearchResults(AppState.filteredItems);
  },

  async handleFileUpload(e) {
    const file = e.target.files[0];
    if (!file) return;

    try {
      Utils.showMessage('ファイルを読み込み中...', 'info');

      const arrayBuffer = await file.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: 'array' });
      const firstSheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheetName];
      const data = XLSX.utils.sheet_to_json(worksheet, { header: ['name', 'points'], range: 1 });

      const validData = data
        .filter(row => row.name && row.points)
        .map(row => ({
          name: String(row.name).trim(),
          points: parseInt(row.points) || 0
        }))
        .filter(item => item.name && item.points > 0);

      if (validData.length === 0) {
        throw new Error('有効なデータが見つかりませんでした');
      }

      Utils.showMessage(`${validData.length}件のデータを保存中...`, 'info');

      // バッチ処理で高速化
      const addedCount = await FirebaseDB.addBatchEquipment(validData);
      
      await this.loadEquipmentData();
      Utils.showMessage(`${addedCount}件のデータを保存しました`, 'success');

    } catch (error) {
      console.error('ファイルアップロードエラー:', error);
      Utils.showMessage(`エラー: ${error.message}`, 'error');
    } finally {
      DOM.fileInput.value = '';
    }
  },

  async handleManualAdd() {
    const name = DOM.manualName.value.trim();
    const points = parseInt(DOM.manualPoints.value);

    if (!name || !points || points <= 0) {
      Utils.showMessage('商品名と有効な点数を入力してください', 'error');
      return;
    }

    try {
      Utils.showMessage('データを保存中...', 'info');
      await FirebaseDB.addEquipment(name, points);
      await this.loadEquipmentData();

      DOM.manualName.value = '';
      DOM.manualPoints.value = '';
      Utils.showMessage(`"${name}" を追加しました`, 'success');

      if (AppState.searchQuery) {
        this.performSearch(AppState.searchQuery);
      }

    } catch (error) {
      console.error('手動追加エラー:', error);
      Utils.showMessage('データの追加に失敗しました', 'error');
    }
  },

  addItem(itemId) {
    const item = AppState.welfareEquipment.find(item => item.id === itemId);
    if (!item) return;

    const existingIndex = AppState.selectedItems.findIndex(selected => selected.id === itemId);
    if (existingIndex !== -1) {
      AppState.selectedItems[existingIndex].quantity += 1;
    } else {
      AppState.selectedItems.push({
        ...item,
        quantity: 1
      });
    }

    UI.updateCalculator();
    this.saveSelectedItems();
    UI.updateSearchResults(AppState.filteredItems);
  },

  updateQuantity(itemId, change) {
    const itemIndex = AppState.selectedItems.findIndex(item => item.id === itemId);
    if (itemIndex === -1) return;

    AppState.selectedItems[itemIndex].quantity = Math.max(1, 
      AppState.selectedItems[itemIndex].quantity + change
    );
    
    UI.updateCalculator();
    this.saveSelectedItems();
    UI.updateSearchResults(AppState.filteredItems);
  },

  removeItem(itemId) {
    AppState.selectedItems = AppState.selectedItems.filter(item => item.id !== itemId);
    UI.updateCalculator();
    this.saveSelectedItems();
    UI.updateSearchResults(AppState.filteredItems);
  },

  async editItem(id, currentName, currentPoints) {
    const newName = prompt('商品名を編集:', currentName);
    if (!newName || newName.trim() === '') return;

    const newPoints = prompt('点数を編集:', currentPoints);
    const points = parseInt(newPoints);
    if (!points || points <= 0) return;

    try {
      Utils.showMessage('データを更新中...', 'info');
      await FirebaseDB.updateEquipment(id, newName.trim(), points);
      await this.loadEquipmentData();
      
      // 選択済みアイテムも更新
      const selectedIndex = AppState.selectedItems.findIndex(item => item.id === id);
      if (selectedIndex !== -1) {
        AppState.selectedItems[selectedIndex].name = newName.trim();
        AppState.selectedItems[selectedIndex].points = points;
        UI.updateCalculator();
        this.saveSelectedItems();
      }
      
      this.performSearch(AppState.searchQuery);
      Utils.showMessage('データを更新しました', 'success');
    } catch (error) {
      console.error('編集エラー:', error);
      Utils.showMessage('データの更新に失敗しました', 'error');
    }
  },

  async deleteItem(id, name) {
    if (!confirm(`"${name}" を削除しますか？\nこの操作は取り消せません。`)) return;

    try {
      Utils.showMessage('データを削除中...', 'info');
      await FirebaseDB.deleteEquipment(id);
      await this.loadEquipmentData();
      
      // 選択済みアイテムからも削除
      AppState.selectedItems = AppState.selectedItems.filter(item => item.id !== id);
      UI.updateCalculator();
      this.saveSelectedItems();
      
      this.performSearch(AppState.searchQuery);
      Utils.showMessage('データを削除しました', 'success');
    } catch (error) {
      console.error('削除エラー:', error);
      Utils.showMessage('データの削除に失敗しました', 'error');
    }
  }
};

// グローバル関数（HTML内のonclickから呼び出すため）
window.App = App;

// アプリケーション起動
window.addEventListener('DOMContentLoaded', () => {
  // Firebase の初期化を待つ
  setTimeout(() => {
    App.init().catch(error => {
      console.error('アプリケーション初期化エラー:', error);
      Utils.showMessage('アプリケーションの起動に失敗しました。ページを再読み込みしてください。', 'error');
    });
  }, 1000);
});

// Service Worker（オフライン対応）
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').catch(err => {
      console.log('Service Worker登録失敗:', err);
    });
  });
}
</script>
</body>
</html>
