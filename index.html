<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="福祉用具計算">
<meta name="theme-color" content="#2563eb">
<title>福祉用具点数計算アプリ</title>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js';
  import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, writeBatch } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js';
  
  // Firebase設定
 const firebaseConfig = {
  apiKey: "AIzaSyCsKv9UDALkSle0CJ4Ag8pxgisWDbdznnI",
  authDomain: "find-assistive-devices-apps.firebaseapp.com",
  projectId: "find-assistive-devices-apps",
  storageBucket: "find-assistive-devices-apps.firebasestorage.app",
  messagingSenderId: "474642604597",
  appId: "1:474642604597:web:5b353b489bac360ba7477c"
};

  // Firebase 初期化
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  
  // グローバルスコープに公開
  window.db = db;
  window.firestore = { collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, writeBatch };
</script>

<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
min-height: 100vh;
padding: env(safe-area-inset-top, 0) env(safe-area-inset-right, 0) env(safe-area-inset-bottom, 0) env(safe-area-inset-left, 0);
}

.container {
max-width: 1200px;
margin: 0 auto;
padding: 20px;
min-height: 100vh;
display: flex;
flex-direction: column;
}

.header {
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(10px);
border-radius: 16px;
padding: 20px;
margin-bottom: 20px;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.title {
font-size: 24px;
font-weight: 700;
color: #1e293b;
margin-bottom: 16px;
text-align: center;
}

.mode-toggle {
display: flex;
gap: 8px;
margin-bottom: 20px;
background: rgba(255, 255, 255, 0.1);
border-radius: 12px;
padding: 4px;
}

.mode-btn {
flex: 1;
background: transparent;
color: rgba(255, 255, 255, 0.7);
border: none;
padding: 12px 16px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
transition: all 0.3s ease;
}

.mode-btn.active {
background: rgba(255, 255, 255, 0.9);
color: #1e293b;
}

.search-container {
position: relative;
margin-bottom: 20px;
}

.search-input {
width: 100%;
padding: 16px 50px 16px 20px;
border: none;
border-radius: 12px;
background: rgba(255, 255, 255, 0.9);
font-size: 16px;
box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
transition: all 0.3s ease;
}

.search-clear-btn {
position: absolute;
right: 15px;
top: 50%;
transform: translateY(-50%);
background: none;
border: none;
cursor: pointer;
width: 28px;
height: 28px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
background: rgba(107, 114, 128, 0.1);
color: #6b7280;
font-size: 16px;
font-weight: bold;
transition: all 0.2s ease;
opacity: 0;
visibility: hidden;
}

.search-clear-btn.visible {
opacity: 1;
visibility: visible;
}

.search-clear-btn:hover {
background: rgba(107, 114, 128, 0.2);
color: #374151;
transform: translateY(-50%) scale(1.1);
}

.admin-panel {
display: none;
background: rgba(255, 255, 255, 0.1);
border-radius: 12px;
padding: 20px;
margin-bottom: 20px;
border: 2px dashed rgba(255, 255, 255, 0.3);
}

.admin-panel.active {
display: block;
}

.upload-section {
margin-bottom: 20px;
}

.file-upload-container {
padding: 20px;
background: rgba(255, 255, 255, 0.1);
border-radius: 12px;
border: 2px dashed rgba(255, 255, 255, 0.3);
text-align: center;
transition: all 0.3s ease;
margin-bottom: 20px;
}

.file-upload-container:hover {
border-color: rgba(255, 255, 255, 0.5);
background: rgba(255, 255, 255, 0.15);
}

.file-input {
display: none;
}

.file-upload-btn {
background: linear-gradient(45deg, #10b981, #059669);
color: white;
border: none;
padding: 12px 24px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
margin-bottom: 8px;
}

.file-upload-text {
color: rgba(255, 255, 255, 0.8);
font-size: 14px;
}

.manual-add {
display: grid;
grid-template-columns: 2fr 1fr 1fr 1fr auto;
gap: 12px;
align-items: end;
}

.input-group {
display: flex;
flex-direction: column;
}

.input-label {
color: rgba(255, 255, 255, 0.9);
font-size: 14px;
font-weight: 600;
margin-bottom: 6px;
}

.manual-input {
padding: 12px 16px;
border: none;
border-radius: 8px;
background: rgba(255, 255, 255, 0.9);
font-size: 14px;
}

.add-manual-btn {
background: linear-gradient(45deg, #3b82f6, #1d4ed8);
color: white;
border: none;
padding: 12px 20px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
height: fit-content;
}

.clear-database-btn {
background: linear-gradient(45deg, #dc2626, #991b1b);
color: white;
border: none;
padding: 12px 24px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
width: 100%;
font-size: 14px;
transition: all 0.3s ease;
}

.clear-database-btn:hover {
transform: translateY(-1px);
box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

.clear-database-btn:active {
transform: translateY(0);
}

.database-management {
display: flex;
flex-direction: column;
gap: 10px;
}

.status-message {
margin-top: 12px;
padding: 8px 16px;
border-radius: 6px;
font-size: 14px;
font-weight: 600;
}

.status-success {
background: #dcfce7;
color: #166534;
}

.status-error {
background: #fecaca;
color: #991b1b;
}

.status-info {
background: #dbeafe;
color: #1e40af;
}

.search-input:focus, .manual-input:focus {
outline: none;
box-shadow: 0 4px 24px rgba(37, 99, 235, 0.2);
transform: translateY(-2px);
}

.main-content {
display: grid;
grid-template-columns: 1fr;
gap: 20px;
flex: 1;
}

@media (min-width: 768px) {
.main-content {
grid-template-columns: 1fr 400px;
}

.manual-add {
grid-template-columns: 2fr 1fr 1fr 1fr auto;
}
}

@media (max-width: 500px) {
.manual-add {
grid-template-columns: 1fr;
gap: 8px;
}

.manual-add .input-group:nth-child(3),
.manual-add .input-group:nth-child(4) {
grid-column: span 1;
}
}

.search-results {
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(10px);
border-radius: 16px;
padding: 20px;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
max-height: 600px;
overflow-y: auto;
}

.result-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 16px;
background: rgba(255, 255, 255, 0.7);
border-radius: 12px;
margin-bottom: 12px;
transition: all 0.3s ease;
}

.result-item:hover {
transform: translateY(-2px);
box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.item-info {
flex: 1;
}

.item-name {
font-weight: 600;
color: #1e293b;
margin-bottom: 4px;
}

.item-points {
color: #6b7280;
font-size: 14px;
}

.item-category, .item-tais-code {
color: #8b5cf6;
font-size: 12px;
font-weight: 500;
margin-top: 2px;
}

.item-category {
color: #059669;
}

.item-tais-code {
color: #d97706;
}

.item-actions {
display: flex;
gap: 8px;
align-items: center;
}

.add-btn, .edit-btn, .delete-btn {
border: none;
padding: 8px 16px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
transition: all 0.3s ease;
font-size: 12px;
}

.add-btn {
background: linear-gradient(45deg, #10b981, #059669);
color: white;
}

.add-btn:hover {
transform: scale(1.05);
}

.add-btn:disabled {
background: #d1d5db;
cursor: not-allowed;
transform: none;
}

.edit-btn {
background: linear-gradient(45deg, #f59e0b, #d97706);
color: white;
}

.delete-btn {
background: linear-gradient(45deg, #ef4444, #dc2626);
color: white;
}

.calculator {
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(10px);
border-radius: 16px;
padding: 20px;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
position: sticky;
top: 20px;
max-height: 80vh;
display: flex;
flex-direction: column;
}

.calculator-title {
font-size: 20px;
font-weight: 700;
color: #1e293b;
margin-bottom: 16px;
display: flex;
justify-content: space-between;
align-items: center;
}

.total-points {
background: linear-gradient(45deg, #2563eb, #1d4ed8);
color: white;
padding: 4px 12px;
border-radius: 20px;
font-size: 16px;
}

.selected-items {
flex: 1;
overflow-y: auto;
margin-bottom: 16px;
}

.selected-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 12px;
background: rgba(255, 255, 255, 0.7);
border-radius: 8px;
margin-bottom: 8px;
}

.selected-item-info {
flex: 1;
}

.selected-item-name {
font-weight: 600;
color: #1e293b;
font-size: 14px;
margin-bottom: 2px;
}

.selected-item-points {
color: #6b7280;
font-size: 12px;
}

.quantity-controls {
display: flex;
align-items: center;
gap: 8px;
margin-right: 8px;
}

.quantity-btn {
background: #e5e7eb;
color: #374151;
border: none;
width: 24px;
height: 24px;
border-radius: 4px;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
font-size: 12px;
font-weight: bold;
transition: all 0.2s ease;
}

.quantity-btn:hover {
background: #d1d5db;
}

.quantity-btn:disabled {
background: #f3f4f6;
color: #9ca3af;
cursor: not-allowed;
}

.quantity-display {
background: #f8fafc;
padding: 2px 8px;
border-radius: 4px;
font-size: 12px;
font-weight: 600;
color: #1e293b;
min-width: 20px;
text-align: center;
}

.remove-btn {
background: #ef4444;
color: white;
border: none;
width: 24px;
height: 24px;
border-radius: 50%;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
font-size: 12px;
transition: all 0.3s ease;
}

.remove-btn:hover {
transform: scale(1.1);
}

.clear-btn {
width: 100%;
background: #6b7280;
color: white;
border: none;
padding: 12px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
transition: all 0.3s ease;
}

.clear-btn:hover {
background: #4b5563;
}

.empty-state {
text-align: center;
color: #6b7280;
padding: 40px 20px;
}

.mobile-toggle {
display: none;
background: linear-gradient(45deg, #2563eb, #1d4ed8);
color: white;
border: none;
padding: 12px 24px;
border-radius: 12px;
cursor: pointer;
font-weight: 600;
margin-bottom: 20px;
position: sticky;
top: 0;
z-index: 10;
}

.loading {
display: flex;
align-items: center;
justify-content: center;
gap: 8px;
padding: 20px;
color: #6b7280;
}

.spinner {
width: 20px;
height: 20px;
border: 2px solid #e5e7eb;
border-top: 2px solid #6b7280;
border-radius: 50%;
animation: spin 1s linear infinite;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

/* モバイル用のレスポンシブ調整 */
@media (max-width: 767px) {
  .container {
    padding: 8px;
    gap: 8px;
  }

  .header {
    margin-bottom: 8px;
    padding: 12px;
  }

  .title {
    font-size: 18px;
    margin-bottom: 8px;
  }

  .mode-toggle {
    margin-bottom: 8px;
    padding: 2px;
  }

  .mode-btn {
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 500;
  }

  .search-container {
    margin-bottom: 8px;
    margin-top: -4px;
  }

  .search-input {
    padding: 12px 40px 12px 16px;
    font-size: 16px;
  }

  .search-clear-btn {
    right: 12px;
    width: 20px;
    height: 20px;
    font-size: 12px;
  }

  .search-results {
    min-height: calc(100vh - 220px);
    max-height: calc(100vh - 220px);
    padding: 15px;
  }

  .main-content {
    flex: 1;
    height: calc(100vh - 210px);
  }

  .mobile-toggle {
    display: block;
    margin-bottom: 10px;
    padding: 10px 20px;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .calculator {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 100;
    max-height: 100vh;
    border-radius: 0;
    margin: 0;
    padding: 20px;
    padding-top: env(safe-area-inset-top, 20px);
    padding-bottom: env(safe-area-inset-bottom, 20px);
  }

  .calculator.show {
    display: flex;
  }

  .close-btn {
    background: #6b7280;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    margin-bottom: 16px;
  }

  .result-item {
    margin-bottom: 8px;
    padding: 12px;
  }

  .item-actions {
    flex-direction: column;
    gap: 4px;
    min-width: 80px;
  }

  .add-btn, .edit-btn, .delete-btn {
    padding: 6px 12px;
    font-size: 11px;
    white-space: nowrap;
  }

  .item-name {
    font-size: 14px;
  }

  .item-points {
    font-size: 12px;
  }

  .container {
    min-height: 100vh;
    min-height: -webkit-fill-available;
  }

  .admin-panel {
    padding: 12px;
    margin-bottom: 8px;
  }

  .manual-add {
    grid-template-columns: 1fr;
    gap: 6px;
  }

  .input-label {
    font-size: 12px;
    margin-bottom: 4px;
  }

  .manual-input {
    padding: 10px 12px;
    font-size: 14px;
  }

  .add-manual-btn {
    padding: 10px 16px;
    font-size: 14px;
  }

  .search-input:focus + .main-content .search-results {
    max-height: 50vh;
  }
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1 class="title">福祉用具点数計算アプリ</h1>

<div class="mode-toggle">
<button class="mode-btn active" id="userMode">利用者モード</button>
<button class="mode-btn" id="adminMode">管理者モード</button>
</div>

<div class="admin-panel" id="adminPanel">
<div class="database-info" style="background: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 15px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.2);">
<div style="display: flex; justify-content: space-between; align-items: center;">
<div>
<h3 style="color: rgba(255, 255, 255, 0.9); margin: 0 0 5px 0; font-size: 16px;">データベース情報</h3>
<p style="color: rgba(255, 255, 255, 0.7); margin: 0; font-size: 14px;">登録件数: <span id="dbCount" style="color: #10b981; font-weight: 600;">読み込み中...</span></p>
</div>
<button class="refresh-count-btn" id="refreshCountBtn" style="background: linear-gradient(45deg, #6366f1, #4f46e5); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
更新
</button>
</div>
</div>

<div class="upload-section">
<div class="file-upload-container">
<input type="file" class="file-input" id="fileInput" accept=".xlsx,.xls">
<button class="file-upload-btn" onclick="document.getElementById('fileInput').click()">
Excelファイルをアップロード
</button>
<div class="file-upload-text">
福祉用具リスト（A列：商品名、B列：点数、C列：品目、D列：taisコード）
</div>
</div>

<div class="manual-add">
<div class="input-group">
<label class="input-label">商品名</label>
<input type="text" class="manual-input" id="manualName" placeholder="商品名を入力">
</div>
<div class="input-group">
<label class="input-label">点数/月</label>
<input type="number" class="manual-input" id="manualPoints" placeholder="点数">
</div>
<div class="input-group">
<label class="input-label">品目</label>
<input type="text" class="manual-input" id="manualCategory" placeholder="品目を入力">
</div>
<div class="input-group">
<label class="input-label">taisコード</label>
<input type="text" class="manual-input" id="manualTaisCode" placeholder="taisコードを入力">
</div>
<button class="add-manual-btn" id="addManualBtn">手動追加</button>
</div>

<div class="database-management" style="margin-top: 20px; padding-top: 20px; border-top: 2px dashed rgba(255, 255, 255, 0.3);">
<button class="clear-database-btn" id="clearDatabaseBtn">データベース全クリア</button>
</div>

<div id="adminStatus"></div>
</div>
</div>

<div class="search-container">
<input type="text" class="search-input" id="searchInput" placeholder="福祉用具を検索...">
<button class="search-clear-btn" id="searchClearBtn">×</button>
</div>
</div>

<button class="mobile-toggle" id="toggleCalculator">
計算結果を表示 (<span id="mobileCount">0</span>件)
</button>

<div class="main-content">
<div class="search-results" id="searchResults">
<div class="loading">
<div class="spinner"></div>
データを読み込み中...
</div>
</div>

<div class="calculator" id="calculator">
<button class="close-btn" id="closeCalculator" style="display: none;">× 閉じる</button>
<div class="calculator-title">
選択した品目
<span class="total-points" id="totalPoints">0点</span>
</div>
<div class="selected-items" id="selectedItems">
<div class="empty-state">
<p>選択された品目がここに表示されます</p>
</div>
</div>
<button class="clear-btn" id="clearAll">全て削除</button>
</div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// グローバル変数
let welfareEquipment = [];
let selectedItems = [];
let filteredItems = [];
let isAdminMode = false;

// DOM要素
const elements = {
userModeBtn: document.getElementById('userMode'),
adminModeBtn: document.getElementById('adminMode'),
adminPanel: document.getElementById('adminPanel'),
fileInput: document.getElementById('fileInput'),
manualName: document.getElementById('manualName'),
manualPoints: document.getElementById('manualPoints'),
manualCategory: document.getElementById('manualCategory'),
manualTaisCode: document.getElementById('manualTaisCode'),
addManualBtn: document.getElementById('addManualBtn'),
clearDatabaseBtn: document.getElementById('clearDatabaseBtn'),
refreshCountBtn: document.getElementById('refreshCountBtn'),
dbCountSpan: document.getElementById('dbCount'),
adminStatus: document.getElementById('adminStatus'),
searchInput: document.getElementById('searchInput'),
searchClearBtn: document.getElementById('searchClearBtn'),
searchResults: document.getElementById('searchResults'),
selectedItemsContainer: document.getElementById('selectedItems'),
totalPointsElement: document.getElementById('totalPoints'),
clearAllBtn: document.getElementById('clearAll'),
toggleCalculatorBtn: document.getElementById('toggleCalculator'),
calculator: document.getElementById('calculator'),
closeCalculatorBtn: document.getElementById('closeCalculator'),
mobileCountSpan: document.getElementById('mobileCount')
};

// Firebase データベース操作
const FirebaseDB = {
async getEquipmentCount() {
try {
const querySnapshot = await window.firestore.getDocs(
window.firestore.collection(window.db, 'welfare_equipment')
);
return querySnapshot.size;
} catch (error) {
console.error('件数取得エラー:', error);
throw error;
}
},

async loadEquipment() {
try {
const q = window.firestore.query(
window.firestore.collection(window.db, 'welfare_equipment'),
window.firestore.orderBy('name')
);
const querySnapshot = await window.firestore.getDocs(q);
const equipment = [];
querySnapshot.forEach((doc) => {
equipment.push({
id: doc.id,
...doc.data()
});
});
return equipment;
} catch (error) {
console.error('データ読み込みエラー:', error);
throw error;
}
},

async addEquipment(name, points, category = '', taisCode = '') {
try {
const docRef = await window.firestore.addDoc(
window.firestore.collection(window.db, 'welfare_equipment'),
{
name: name.trim(),
points: parseInt(points),
category: category.trim(),
taisCode: taisCode.trim(),
createdAt: new Date()
}
);
return docRef.id;
} catch (error) {
console.error('データ追加エラー:', error);
throw error;
}
},

async updateEquipment(id, name, points, category = '', taisCode = '') {
try {
await window.firestore.updateDoc(
window.firestore.doc(window.db, 'welfare_equipment', id),
{
name: name.trim(),
points: parseInt(points),
category: category.trim(),
taisCode: taisCode.trim(),
updatedAt: new Date()
}
);
} catch (error) {
console.error('データ更新エラー:', error);
throw error;
}
},

async deleteEquipment(id) {
try {
await window.firestore.deleteDoc(
window.firestore.doc(window.db, 'welfare_equipment', id)
);
} catch (error) {
console.error('データ削除エラー:', error);
throw error;
}
},

async clearAllEquipment() {
try {
const q = window.firestore.query(
window.firestore.collection(window.db, 'welfare_equipment')
);
const querySnapshot = await window.firestore.getDocs(q);

const deletePromises = [];
querySnapshot.forEach((doc) => {
deletePromises.push(
window.firestore.deleteDoc(
window.firestore.doc(window.db, 'welfare_equipment', doc.id)
)
);
});

await Promise.all(deletePromises);
return querySnapshot.size;
} catch (error) {
console.error('全データ削除エラー:', error);
throw error;
}
}
};

// 初期化
async function initializeApp() {
try {
await loadEquipmentData();
await updateDatabaseCount(); // 件数を表示
showEmptySearchState();
loadSelectedItems();
} catch (error) {
showError('データベース接続エラーが発生しました。');
}
}

// 福祉用具データの読み込み
async function loadEquipmentData() {
try {
welfareEquipment = await FirebaseDB.loadEquipment();
filteredItems = welfareEquipment;
showInfo(`${welfareEquipment.length}件のデータを読み込みました`);
} catch (error) {
throw error;
}
}

// データベース件数の更新
async function updateDatabaseCount() {
try {
const count = await FirebaseDB.getEquipmentCount();
elements.dbCountSpan.textContent = `${count.toLocaleString()}件`;
} catch (error) {
elements.dbCountSpan.textContent = 'エラー';
console.error('件数取得エラー:', error);
}
}

// 選択済みアイテムの読み込み
function loadSelectedItems() {
try {
const saved = sessionStorage.getItem('selectedWelfareItems');
if (saved) {
selectedItems = JSON.parse(saved);
updateCalculator();
updateMobileCount();
}
} catch (error) {
selectedItems = [];
}
}

// 選択済みアイテムの保存
function saveSelectedItems() {
try {
sessionStorage.setItem('selectedWelfareItems', JSON.stringify(selectedItems));
} catch (error) {
console.error('選択アイテム保存エラー:', error);
}
}

// モード切り替え
elements.userModeBtn.addEventListener('click', () => switchMode(false));
elements.adminModeBtn.addEventListener('click', () => switchMode(true));

function switchMode(admin) {
isAdminMode = admin;
elements.userModeBtn.classList.toggle('active', !admin);
elements.adminModeBtn.classList.toggle('active', admin);
elements.adminPanel.classList.toggle('active', admin);

// 検索結果を更新
if (elements.searchInput.value.trim()) {
performSearch(elements.searchInput.value);
} else {
showEmptySearchState();
}
}

// Excel ファイルアップロード
elements.fileInput.addEventListener('change', handleFileUpload);

async function handleFileUpload(e) {
const file = e.target.files[0];
if (!file) return;

try {
showInfo('ファイルを読み込み中...');

const arrayBuffer = await file.arrayBuffer();
const workbook = XLSX.read(arrayBuffer, { type: 'array' });
const firstSheetName = workbook.SheetNames[0];
const worksheet = workbook.Sheets[firstSheetName];
const data = XLSX.utils.sheet_to_json(worksheet, { header: ['name', 'points', 'category', 'taisCode'], range: 1 });

const validData = data
.filter(row => row.name && row.points)
.map(row => ({
name: String(row.name).trim(),
points: parseInt(row.points) || 0,
category: row.category ? String(row.category).trim() : '',
taisCode: row.taisCode ? String(row.taisCode).trim() : ''
}))
.filter(item => item.name && item.points > 0);

if (validData.length === 0) {
throw new Error('有効なデータが見つかりませんでした');
}

showInfo(`${validData.length}件のデータをデータベースに保存中...`);

// Firebase に保存（最高速バッチ処理）
showInfo(`${validData.length}件のデータを高速保存中...`);

try {
addedCount = await FirebaseDB.addBulkEquipment(validData);
} catch (error) {
console.error('高速保存でエラーが発生しました:', error);
showError('高速保存に失敗しました。個別保存に切り替えます...');

// フォールバック：個別処理
addedCount = 0;
for (const item of validData) {
try {
await FirebaseDB.addEquipment(item.name, item.points, item.category, item.taisCode);
addedCount++;
if (addedCount % 100 === 0) {
showInfo(`${addedCount}/${validData.length}件保存完了...`);
}
} catch (error) {
console.error(`"${item.name}" の保存に失敗:`, error);
}
}
}

// データを再読み込み
await loadEquipmentData();
await updateDatabaseCount(); // 件数も更新
showEmptySearchState();

showSuccess(`${addedCount}件のデータをデータベースに保存しました`);

} catch (error) {
console.error('ファイルアップロードエラー:', error);
showError(`エラー: ${error.message}`);
} finally {
elements.fileInput.value = '';
}
}

// 手動追加
elements.addManualBtn.addEventListener('click', handleManualAdd);

// データベース全クリア
elements.clearDatabaseBtn.addEventListener('click', handleClearDatabase);

// 件数更新
elements.refreshCountBtn.addEventListener('click', updateDatabaseCount);

async function handleClearDatabase() {
// 二重確認で安全性を高める
const firstConfirm = confirm('⚠️ 警告: データベースの全データが削除されます。\nこの操作は取り消せません。\n\n本当に続行しますか？');
if (!firstConfirm) return;

const secondConfirm = confirm('最終確認: 全ての福祉用具データが完全に削除されます。\n\n削除を実行しますか？');
if (!secondConfirm) return;

try {
showInfo('データベースを全クリア中...');
const deletedCount = await FirebaseDB.clearAllEquipment();

// ローカルデータも初期化
welfareEquipment = [];
filteredItems = [];
selectedItems = [];

// 画面を更新
updateCalculator();
updateMobileCount();
saveSelectedItems();
showEmptySearchState();
elements.searchInput.value = '';
toggleClearButton('');
await updateDatabaseCount(); // 件数も更新

showSuccess(`${deletedCount}件のデータを削除しました。データベースが空になりました。`);

} catch (error) {
console.error('データベース全クリアエラー:', error);
showError('データベースの全クリアに失敗しました');
}
}

async function handleManualAdd() {
const name = elements.manualName.value.trim();
const points = parseInt(elements.manualPoints.value);
const category = elements.manualCategory.value.trim();
const taisCode = elements.manualTaisCode.value.trim();

if (!name || !points || points <= 0) {
showError('商品名と有効な点数を入力してください');
return;
}

try {
showInfo('データを保存中...');
await FirebaseDB.addEquipment(name, points, category, taisCode);
await loadEquipmentData();
await updateDatabaseCount(); // 件数も更新

elements.manualName.value = '';
elements.manualPoints.value = '';
elements.manualCategory.value = '';
elements.manualTaisCode.value = '';
showSuccess(`"${name}" を追加しました`);

// 検索結果を更新
if (elements.searchInput.value.trim()) {
performSearch(elements.searchInput.value);
} else {
showEmptySearchState();
}

} catch (error) {
console.error('手動追加エラー:', error);
showError('データの追加に失敗しました');
}
}

// 検索機能
elements.searchInput.addEventListener('input', (e) => {
const query = e.target.value.trim();
toggleClearButton(query);
if (query === '') {
showEmptySearchState();
} else {
performSearch(query);
}
});

// 検索クリアボタンの表示/非表示切り替え
function toggleClearButton(query) {
if (query) {
elements.searchClearBtn.classList.add('visible');
} else {
elements.searchClearBtn.classList.remove('visible');
}
}

// 検索クリアボタンのイベントリスナー
elements.searchClearBtn.addEventListener('click', () => {
elements.searchInput.value = '';
elements.searchClearBtn.classList.remove('visible');
showEmptySearchState();
elements.searchInput.focus();
});

function performSearch(query) {
if (welfareEquipment.length === 0) {
showNoDataState();
return;
}

filteredItems = welfareEquipment.filter(item => 
item.name.toLowerCase().includes(query.toLowerCase())
);

displaySearchResults(filteredItems);
}

function displaySearchResults(items) {
if (items.length === 0) {
elements.searchResults.innerHTML = `
<div class="empty-state">
<h3>該当する品目が見つかりません</h3>
<p>別のキーワードで検索してみてください</p>
</div>
`;
return;
}

elements.searchResults.innerHTML = items.map(item => {
const selectedItem = selectedItems.find(selected => selected.id === item.id);
const isSelected = !!selectedItem;
const quantity = selectedItem ? selectedItem.quantity : 0;

const adminButtons = isAdminMode ? `
<button class="edit-btn" onclick="editItem('${item.id}', '${item.name.replace(/'/g, "\\'")}', ${item.points}, '${(item.category || '').replace(/'/g, "\\'")}', '${(item.taisCode || '').replace(/'/g, "\\'")}')">編集</button>
<button class="delete-btn" onclick="deleteItem('${item.id}', '${item.name.replace(/'/g, "\\'")}')">削除</button>
` : '';

const categoryDisplay = item.category ? `<div class="item-category">品目: ${item.category}</div>` : '';
const taisCodeDisplay = item.taisCode ? `<div class="item-tais-code">taisコード: ${item.taisCode}</div>` : '';

return `
<div class="result-item">
<div class="item-info">
<div class="item-name">${item.name}</div>
<div class="item-points">${item.points}点/月</div>
${categoryDisplay}
${taisCodeDisplay}
</div>
<div class="item-actions">
<button class="add-btn" onclick="addItem('${item.id}')">
${isSelected ? `追加済み (${quantity}個)` : '追加'}
</button>
${adminButtons}
</div>
</div>
`;
}).join('');
}

// アイテム操作
function addItem(itemId) {
const item = welfareEquipment.find(item => item.id === itemId);
if (!item) return;

const existingIndex = selectedItems.findIndex(selected => selected.id === itemId);
if (existingIndex !== -1) {
selectedItems[existingIndex].quantity += 1;
} else {
selectedItems.push({
...item,
quantity: 1
});
}

updateCalculator();
updateMobileCount();
saveSelectedItems();
displaySearchResults(filteredItems);
}

function updateQuantity(itemId, change) {
const itemIndex = selectedItems.findIndex(item => item.id === itemId);
if (itemIndex === -1) return;

selectedItems[itemIndex].quantity = Math.max(1, selectedItems[itemIndex].quantity + change);
updateCalculator();
updateMobileCount();
saveSelectedItems();
displaySearchResults(filteredItems);
}

function removeItem(itemId) {
selectedItems = selectedItems.filter(item => item.id !== itemId);
updateCalculator();
updateMobileCount();
saveSelectedItems();
displaySearchResults(filteredItems);
}

async function editItem(id, currentName, currentPoints, currentCategory = '', currentTaisCode = '') {
const newName = prompt('商品名を編集:', currentName);
if (!newName || newName.trim() === '') return;

const newPoints = prompt('点数を編集:', currentPoints);
const points = parseInt(newPoints);
if (!points || points <= 0) return;

const newCategory = prompt('品目を編集:', currentCategory);
const category = newCategory !== null ? newCategory.trim() : '';

const newTaisCode = prompt('taisコードを編集:', currentTaisCode);
const taisCode = newTaisCode !== null ? newTaisCode.trim() : '';

try {
showInfo('データを更新中...');
await FirebaseDB.updateEquipment(id, newName.trim(), points, category, taisCode);
await loadEquipmentData();
await updateDatabaseCount(); // 件数も更新（変更はないが、整合性のため）
performSearch(elements.searchInput.value);
showSuccess('データを更新しました');
} catch (error) {
console.error('編集エラー:', error);
showError('データの更新に失敗しました');
}
}

async function deleteItem(id, name) {
if (!confirm(`"${name}" を削除しますか？`)) return;

try {
showInfo('データを削除中...');
await FirebaseDB.deleteEquipment(id);
await loadEquipmentData();
await updateDatabaseCount(); // 件数も更新
performSearch(elements.searchInput.value);
showSuccess('データを削除しました');
} catch (error) {
console.error('削除エラー:', error);
showError('データの削除に失敗しました');
}
}

// 計算機更新
function updateCalculator() {
const totalPoints = selectedItems.reduce((sum, item) => sum + (item.points * item.quantity), 0);
elements.totalPointsElement.textContent = `${totalPoints}点`;

if (selectedItems.length === 0) {
elements.selectedItemsContainer.innerHTML = `
<div class="empty-state">
<p>選択された品目がここに表示されます</p>
</div>
`;
} else {
elements.selectedItemsContainer.innerHTML = selectedItems.map(item => {
const taisCodeDisplay = item.taisCode ? `<div class="selected-item-tais" style="color: #d97706; font-size: 11px; font-weight: 500; margin-top: 2px;">taisコード: ${item.taisCode}</div>` : '';

return `
<div class="selected-item">
<div class="selected-item-info">
<div class="selected-item-name">${item.name}</div>
<div class="selected-item-points">${item.points}点/月 × ${item.quantity}個 = ${item.points * item.quantity}点</div>
${taisCodeDisplay}
</div>
<div class="quantity-controls">
<button class="quantity-btn" onclick="updateQuantity('${item.id}', -1)" ${item.quantity <= 1 ? 'disabled' : ''}>−</button>
<div class="quantity-display">${item.quantity}</div>
<button class="quantity-btn" onclick="updateQuantity('${item.id}', 1)">+</button>
</div>
<button class="remove-btn" onclick="removeItem('${item.id}')">×</button>
</div>
`;
}).join('');
}
}

function updateMobileCount() {
const totalItems = selectedItems.reduce((sum, item) => sum + item.quantity, 0);
elements.mobileCountSpan.textContent = totalItems;
}

// 全削除
elements.clearAllBtn.addEventListener('click', () => {
selectedItems = [];
updateCalculator();
updateMobileCount();
saveSelectedItems();
displaySearchResults(filteredItems);
});

// モバイル表示切り替え
elements.toggleCalculatorBtn.addEventListener('click', () => {
elements.calculator.classList.add('show');
elements.closeCalculatorBtn.style.display = 'block';
});

elements.closeCalculatorBtn.addEventListener('click', () => {
elements.calculator.classList.remove('show');
elements.closeCalculatorBtn.style.display = 'none';
});

// 状態表示関数
function showEmptySearchState() {
elements.searchResults.innerHTML = `
<div class="empty-state">
<h3>福祉用具を検索してください</h3>
<p>品目名を入力すると検索結果が表示されます</p>
</div>
`;
}

function showNoDataState() {
elements.searchResults.innerHTML = `
<div class="empty-state">
<h3>データがありません</h3>
<p>管理者モードでデータを追加してください</p>
</div>
`;
}

function showInfo(message) {
elements.adminStatus.innerHTML = `<div class="status-message status-info">${message}</div>`;
setTimeout(clearStatus, 3000);
}

function showSuccess(message) {
elements.adminStatus.innerHTML = `<div class="status-message status-success">${message}</div>`;
setTimeout(clearStatus, 5000);
}

function showError(message) {
elements.adminStatus.innerHTML = `<div class="status-message status-error">${message}</div>`;
setTimeout(clearStatus, 8000);
}

function clearStatus() {
elements.adminStatus.innerHTML = '';
}

// アプリケーション初期化
window.addEventListener('load', () => {
// Firebase が読み込まれるまで少し待つ
setTimeout(initializeApp, 1000);
});
</script>
</body>
</html>
