<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ç¦ç¥‰ç”¨å…·è¨ˆç®—">
<meta name="theme-color" content="#2563eb">
<title>ç¦ç¥‰ç”¨å…·ç‚¹æ•°è¨ˆç®—ã‚¢ãƒ—ãƒª</title>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js';
  import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, writeBatch } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js';
  
  // Firebaseè¨­å®š
 const firebaseConfig = {
  apiKey: "AIzaSyCsKv9UDALkSle0CJ4Ag8pxgisWDbdznnI",
  authDomain: "find-assistive-devices-apps.firebaseapp.com",
  projectId: "find-assistive-devices-apps",
  storageBucket: "find-assistive-devices-apps.firebasestorage.app",
  messagingSenderId: "474642604597",
  appId: "1:474642604597:web:5b353b489bac360ba7477c"
};

  // Firebase åˆæœŸåŒ–
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹
  window.db = db;
  window.firestore = { collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, writeBatch };
</script>

<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
min-height: 100vh;
padding: env(safe-area-inset-top, 0) env(safe-area-inset-right, 0) env(safe-area-inset-bottom, 0) env(safe-area-inset-left, 0);
}

.container {
max-width: 1200px;
margin: 0 auto;
padding: 20px;
min-height: 100vh;
display: flex;
flex-direction: column;
}

.header {
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(10px);
border-radius: 16px;
padding: 20px;
margin-bottom: 20px;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.title {
font-size: 24px;
font-weight: 700;
color: #1e293b;
margin-bottom: 16px;
text-align: center;
}

.mode-toggle {
display: flex;
gap: 8px;
margin-bottom: 20px;
background: rgba(255, 255, 255, 0.1);
border-radius: 12px;
padding: 4px;
}

.mode-btn {
flex: 1;
background: transparent;
color: rgba(255, 255, 255, 0.7);
border: none;
padding: 12px 16px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
transition: all 0.3s ease;
}

.mode-btn.active {
background: rgba(255, 255, 255, 0.9);
color: #1e293b;
}

.search-container {
position: relative;
margin-bottom: 20px;
}

.search-input {
width: 100%;
padding: 16px 50px 16px 20px;
border: none;
border-radius: 12px;
background: rgba(255, 255, 255, 0.9);
font-size: 16px;
box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
transition: all 0.3s ease;
}

.search-clear-btn {
position: absolute;
right: 15px;
top: 50%;
transform: translateY(-50%);
background: none;
border: none;
cursor: pointer;
width: 28px;
height: 28px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
background: rgba(107, 114, 128, 0.1);
color: #6b7280;
font-size: 16px;
font-weight: bold;
transition: all 0.2s ease;
opacity: 0;
visibility: hidden;
}

.search-clear-btn.visible {
opacity: 1;
visibility: visible;
}

.search-clear-btn:hover {
background: rgba(107, 114, 128, 0.2);
color: #374151;
transform: translateY(-50%) scale(1.1);
}

.admin-panel {
display: none;
background: rgba(255, 255, 255, 0.1);
border-radius: 12px;
padding: 20px;
margin-bottom: 20px;
border: 2px dashed rgba(255, 255, 255, 0.3);
}

.admin-panel.active {
display: block;
}

.upload-section {
margin-bottom: 20px;
}

.file-upload-container {
padding: 20px;
background: rgba(255, 255, 255, 0.1);
border-radius: 12px;
border: 2px dashed rgba(255, 255, 255, 0.3);
text-align: center;
transition: all 0.3s ease;
margin-bottom: 20px;
}

.file-upload-container:hover {
border-color: rgba(255, 255, 255, 0.5);
background: rgba(255, 255, 255, 0.15);
}

.file-input {
display: none;
}

.file-upload-btn {
background: linear-gradient(45deg, #10b981, #059669);
color: white;
border: none;
padding: 12px 24px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
margin-bottom: 8px;
}

.file-upload-text {
color: rgba(255, 255, 255, 0.8);
font-size: 14px;
}

.manual-add {
display: grid;
grid-template-columns: 2fr 1fr 1fr 1fr auto;
gap: 12px;
align-items: end;
}

.input-group {
display: flex;
flex-direction: column;
}

.input-label {
color: rgba(255, 255, 255, 0.9);
font-size: 14px;
font-weight: 600;
margin-bottom: 6px;
}

.manual-input {
padding: 12px 16px;
border: none;
border-radius: 8px;
background: rgba(255, 255, 255, 0.9);
font-size: 14px;
}

.add-manual-btn {
background: linear-gradient(45deg, #3b82f6, #1d4ed8);
color: white;
border: none;
padding: 12px 20px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
height: fit-content;
}

.clear-database-btn {
background: linear-gradient(45deg, #dc2626, #991b1b);
color: white;
border: none;
padding: 12px 24px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
width: 100%;
font-size: 14px;
transition: all 0.3s ease;
}

.clear-database-btn:hover {
transform: translateY(-1px);
box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

.clear-database-btn:active {
transform: translateY(0);
}

.database-management {
display: flex;
flex-direction: column;
gap: 10px;
}

.status-message {
margin-top: 12px;
padding: 8px 16px;
border-radius: 6px;
font-size: 14px;
font-weight: 600;
}

.status-success {
background: #dcfce7;
color: #166534;
}

.status-error {
background: #fecaca;
color: #991b1b;
}

.status-info {
background: #dbeafe;
color: #1e40af;
}

.search-input:focus, .manual-input:focus {
outline: none;
box-shadow: 0 4px 24px rgba(37, 99, 235, 0.2);
transform: translateY(-2px);
}

.main-content {
display: grid;
grid-template-columns: 1fr;
gap: 20px;
flex: 1;
}

@media (min-width: 768px) {
.main-content {
grid-template-columns: 1fr 400px;
}

.manual-add {
grid-template-columns: 2fr 1fr 1fr 1fr auto;
}
}

@media (max-width: 500px) {
.manual-add {
grid-template-columns: 1fr;
gap: 8px;
}

.manual-add .input-group:nth-child(3),
.manual-add .input-group:nth-child(4) {
grid-column: span 1;
}
}

.search-results {
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(10px);
border-radius: 16px;
padding: 20px;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
max-height: 600px;
overflow-y: auto;
}

.result-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 16px;
background: rgba(255, 255, 255, 0.7);
border-radius: 12px;
margin-bottom: 12px;
transition: all 0.3s ease;
}

.result-item:hover {
transform: translateY(-2px);
box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.item-info {
flex: 1;
}

.item-name {
font-weight: 600;
color: #1e293b;
margin-bottom: 4px;
}

.item-points {
color: #6b7280;
font-size: 14px;
}

.item-category, .item-tais-code {
color: #8b5cf6;
font-size: 12px;
font-weight: 500;
margin-top: 2px;
}

.item-category {
color: #059669;
}

.item-tais-code {
color: #d97706;
}

.item-actions {
display: flex;
gap: 8px;
align-items: center;
}

.add-btn, .edit-btn, .delete-btn {
border: none;
padding: 8px 16px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
transition: all 0.3s ease;
font-size: 12px;
}

.add-btn {
background: linear-gradient(45deg, #10b981, #059669);
color: white;
}

.add-btn:hover {
transform: scale(1.05);
}

.add-btn:disabled {
background: #d1d5db;
cursor: not-allowed;
transform: none;
}

.edit-btn {
background: linear-gradient(45deg, #f59e0b, #d97706);
color: white;
}

.delete-btn {
background: linear-gradient(45deg, #ef4444, #dc2626);
color: white;
}

.calculator {
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(10px);
border-radius: 16px;
padding: 20px;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
position: sticky;
top: 20px;
max-height: 80vh;
display: flex;
flex-direction: column;
}

.calculator-title {
font-size: 20px;
font-weight: 700;
color: #1e293b;
margin-bottom: 16px;
display: flex;
justify-content: space-between;
align-items: center;
flex-wrap: wrap;
gap: 8px;
}

.actual-cost-btn {
background: linear-gradient(45deg, #f59e0b, #d97706);
color: white;
border: none;
padding: 8px 16px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
transition: all 0.3s ease;
font-size: 12px;
}

.actual-cost-btn.active {
background: linear-gradient(45deg, #dc2626, #991b1b);
}

.actual-cost-btn:hover {
transform: scale(1.05);
}

.calculator-header-left {
display: flex;
align-items: center;
gap: 12px;
}

.actual-cost-total {
background: linear-gradient(45deg, #dc2626, #991b1b);
color: white;
padding: 4px 12px;
border-radius: 20px;
font-size: 14px;
margin-left: 8px;
}

.print-btn {
background: linear-gradient(45deg, #8b5cf6, #7c3aed);
color: white;
border: none;
padding: 8px 16px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
font-size: 14px;
transition: all 0.3s ease;
display: flex;
align-items: center;
gap: 6px;
}

.print-btn:hover {
transform: translateY(-1px);
box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}

.print-btn:disabled {
background: #d1d5db;
cursor: not-allowed;
transform: none;
box-shadow: none;
}

.total-points {
background: linear-gradient(45deg, #2563eb, #1d4ed8);
color: white;
padding: 4px 12px;
border-radius: 20px;
font-size: 16px;
}

.selected-items {
flex: 1;
overflow-y: auto;
margin-bottom: 16px;
}

.selected-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 12px;
background: rgba(255, 255, 255, 0.7);
border-radius: 8px;
margin-bottom: 8px;
cursor: move;
transition: all 0.3s ease;
}

.selected-item:hover {
background: rgba(255, 255, 255, 0.8);
transform: translateY(-1px);
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.selected-item.dragging {
opacity: 0.5;
transform: rotate(3deg);
z-index: 1000;
box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
}

.selected-item.drag-over {
border-top: 3px solid #2563eb;
}

.drag-handle {
display: flex;
align-items: center;
justify-content: center;
width: 20px;
height: 40px;
color: #9ca3af;
cursor: grab;
margin-right: 12px;
font-size: 14px;
transition: color 0.2s ease;
}

.drag-handle:hover {
color: #4b5563;
}

.drag-handle:active {
cursor: grabbing;
}

.selected-item-info {
flex: 1;
}

.selected-item-name {
font-weight: 600;
color: #1e293b;
font-size: 14px;
margin-bottom: 2px;
}

.selected-item-points {
color: #6b7280;
font-size: 12px;
}

.quantity-controls {
display: flex;
align-items: center;
gap: 8px;
margin-right: 8px;
}

.quantity-btn {
background: #e5e7eb;
color: #374151;
border: none;
width: 24px;
height: 24px;
border-radius: 4px;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
font-size: 12px;
font-weight: bold;
transition: all 0.2s ease;
}

.quantity-btn:hover {
background: #d1d5db;
}

.quantity-btn:disabled {
background: #f3f4f6;
color: #9ca3af;
cursor: not-allowed;
}

.quantity-display {
background: #f8fafc;
padding: 2px 8px;
border-radius: 4px;
font-size: 12px;
font-weight: 600;
color: #1e293b;
min-width: 20px;
text-align: center;
}

.remove-btn {
background: #ef4444;
color: white;
border: none;
width: 24px;
height: 24px;
border-radius: 50%;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
font-size: 12px;
transition: all 0.3s ease;
}

.remove-btn:hover {
transform: scale(1.1);
}

.clear-btn {
width: 100%;
background: #6b7280;
color: white;
border: none;
padding: 12px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
transition: all 0.3s ease;
}

.clear-btn:hover {
background: #4b5563;
}

.empty-state {
text-align: center;
color: #6b7280;
padding: 40px 20px;
}

.mobile-toggle {
display: none;
background: linear-gradient(45deg, #2563eb, #1d4ed8);
color: white;
border: none;
padding: 12px 24px;
border-radius: 12px;
cursor: pointer;
font-weight: 600;
margin-bottom: 20px;
position: sticky;
top: 0;
z-index: 10;
}

.loading {
display: flex;
align-items: center;
justify-content: center;
gap: 8px;
padding: 20px;
color: #6b7280;
}

.spinner {
width: 20px;
height: 20px;
border: 2px solid #e5e7eb;
border-top: 2px solid #6b7280;
border-radius: 50%;
animation: spin 1s linear infinite;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

/* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ */
@media (max-width: 767px) {
  .container {
    padding: 8px;
    gap: 8px;
  }

  .header {
    margin-bottom: 8px;
    padding: 12px;
  }

  .title {
    font-size: 18px;
    margin-bottom: 8px;
  }

  .mode-toggle {
    margin-bottom: 8px;
    padding: 2px;
  }

  .mode-btn {
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 500;
  }

  .search-container {
    margin-bottom: 8px;
    margin-top: -4px;
  }

  .search-input {
    padding: 12px 40px 12px 16px;
    font-size: 16px;
  }

  .search-clear-btn {
    right: 12px;
    width: 20px;
    height: 20px;
    font-size: 12px;
  }

  .search-results {
    min-height: calc(100vh - 220px);
    max-height: calc(100vh - 220px);
    padding: 15px;
  }

  .main-content {
    flex: 1;
    height: calc(100vh - 210px);
  }

  .mobile-toggle {
    display: block;
    margin-bottom: 10px;
    padding: 10px 20px;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .calculator {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 100;
    max-height: 100vh;
    border-radius: 0;
    margin: 0;
    padding: 20px;
    padding-top: env(safe-area-inset-top, 20px);
    padding-bottom: env(safe-area-inset-bottom, 20px);
  }

  .calculator.show {
    display: flex;
  }

  .close-btn {
    background: #6b7280;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    margin-bottom: 16px;
  }

  .result-item {
    margin-bottom: 8px;
    padding: 12px;
  }

  .item-actions {
    flex-direction: column;
    gap: 4px;
    min-width: 80px;
  }

  .add-btn, .edit-btn, .delete-btn {
    padding: 6px 12px;
    font-size: 11px;
    white-space: nowrap;
  }

  .item-name {
    font-size: 14px;
  }

  .item-points {
    font-size: 12px;
  }

  .container {
    min-height: 100vh;
    min-height: -webkit-fill-available;
  }

  .admin-panel {
    padding: 12px;
    margin-bottom: 8px;
  }

  .manual-add {
    grid-template-columns: 1fr;
    gap: 6px;
  }

  .input-label {
    font-size: 12px;
    margin-bottom: 4px;
  }

  .manual-input {
    padding: 10px 12px;
    font-size: 14px;
  }

  .add-manual-btn {
    padding: 10px 16px;
    font-size: 14px;
  }

  .search-input:focus + .main-content .search-results {
    max-height: 50vh;
  }

  .calculator-title {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  .calculator-header-left {
    width: 100%;
    justify-content: space-between;
  }

  .print-btn {
    padding: 6px 12px;
    font-size: 12px;
  }
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1 class="title">ç¦ç¥‰ç”¨å…·ç‚¹æ•°è¨ˆç®—ã‚¢ãƒ—ãƒª</h1>

<div class="mode-toggle">
<button class="mode-btn active" id="userMode">åˆ©ç”¨è€…ãƒ¢ãƒ¼ãƒ‰</button>
<button class="mode-btn" id="adminMode">ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰</button>
</div>

<div class="admin-panel" id="adminPanel">
<div class="database-info" style="background: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 15px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.2);">
<div style="display: flex; justify-content: space-between; align-items: center;">
<div>
<h3 style="color: rgba(255, 255, 255, 0.9); margin: 0 0 5px 0; font-size: 16px;">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±</h3>
<p style="color: rgba(255, 255, 255, 0.7); margin: 0; font-size: 14px;">ç™»éŒ²ä»¶æ•°: <span id="dbCount" style="color: #10b981; font-weight: 600;">èª­ã¿è¾¼ã¿ä¸­...</span></p>
</div>
<button class="refresh-count-btn" id="refreshCountBtn" style="background: linear-gradient(45deg, #6366f1, #4f46e5); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
æ›´æ–°
</button>
</div>
</div>

<div class="upload-section">
<div class="file-upload-container">
<input type="file" class="file-input" id="fileInput" accept=".xlsx,.xls">
<button class="file-upload-btn" onclick="document.getElementById('fileInput').click()">
Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
</button>
<div class="file-upload-text">
ç¦ç¥‰ç”¨å…·ãƒªã‚¹ãƒˆï¼ˆAåˆ—ï¼šå•†å“åã€Båˆ—ï¼šç‚¹æ•°ã€Cåˆ—ï¼šå“ç›®ã€Dåˆ—ï¼štaisã‚³ãƒ¼ãƒ‰ï¼‰
</div>
</div>

<div class="manual-add">
<div class="input-group">
<label class="input-label">å•†å“å</label>
<input type="text" class="manual-input" id="manualName" placeholder="å•†å“åã‚’å…¥åŠ›">
</div>
<div class="input-group">
<label class="input-label">ç‚¹æ•°/æœˆ</label>
<input type="number" class="manual-input" id="manualPoints" placeholder="ç‚¹æ•°">
</div>
<div class="input-group">
<label class="input-label">å“ç›®</label>
<input type="text" class="manual-input" id="manualCategory" placeholder="å“ç›®ã‚’å…¥åŠ›">
</div>
<div class="input-group">
<label class="input-label">taisã‚³ãƒ¼ãƒ‰</label>
<input type="text" class="manual-input" id="manualTaisCode" placeholder="taisã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
</div>
<button class="add-manual-btn" id="addManualBtn">æ‰‹å‹•è¿½åŠ </button>
</div>

<div class="database-management" style="margin-top: 20px; padding-top: 20px; border-top: 2px dashed rgba(255, 255, 255, 0.3);">
<button class="clear-database-btn" id="clearDatabaseBtn">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å…¨ã‚¯ãƒªã‚¢</button>
</div>

<div id="adminStatus"></div>
</div>
</div>

<div class="search-container">
<input type="text" class="search-input" id="searchInput" placeholder="ç¦ç¥‰ç”¨å…·ã‚’æ¤œç´¢...">
<button class="search-clear-btn" id="searchClearBtn">Ã—</button>
</div>
</div>

<button class="mobile-toggle" id="toggleCalculator">
è¨ˆç®—çµæœã‚’è¡¨ç¤º (<span id="mobileCount">0</span>ä»¶)
</button>

<div class="main-content">
<div class="search-results" id="searchResults">
<div class="loading">
<div class="spinner"></div>
ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
</div>
</div>

<div class="calculator" id="calculator">
<button class="close-btn" id="closeCalculator" style="display: none;">Ã— é–‰ã˜ã‚‹</button>
<div class="calculator-title">
<div class="calculator-header-left">
é¸æŠã—ãŸå“ç›®
<button class="print-btn" id="printBtn">
ğŸ“„ å°åˆ·
</button>
</div>
<div style="display: flex; align-items: center;">
<span class="total-points" id="totalPoints">0ç‚¹</span>
<span class="actual-cost-total" id="actualCostTotal" style="display: none;">0å††</span>
</div>
</div>
<div class="selected-items" id="selectedItems">
<div class="empty-state">
<p>é¸æŠã•ã‚ŒãŸå“ç›®ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
</div>
</div>
<button class="clear-btn" id="clearAll">å…¨ã¦å‰Šé™¤</button>
</div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let welfareEquipment = [];
let selectedItems = [];
let filteredItems = [];
let isAdminMode = false;

// DOMè¦ç´ 
const elements = {
userModeBtn: document.getElementById('userMode'),
adminModeBtn: document.getElementById('adminMode'),
adminPanel: document.getElementById('adminPanel'),
fileInput: document.getElementById('fileInput'),
manualName: document.getElementById('manualName'),
manualPoints: document.getElementById('manualPoints'),
manualCategory: document.getElementById('manualCategory'),
manualTaisCode: document.getElementById('manualTaisCode'),
addManualBtn: document.getElementById('addManualBtn'),
clearDatabaseBtn: document.getElementById('clearDatabaseBtn'),
refreshCountBtn: document.getElementById('refreshCountBtn'),
dbCountSpan: document.getElementById('dbCount'),
adminStatus: document.getElementById('adminStatus'),
searchInput: document.getElementById('searchInput'),
searchClearBtn: document.getElementById('searchClearBtn'),
searchResults: document.getElementById('searchResults'),
selectedItemsContainer: document.getElementById('selectedItems'),
totalPointsElement: document.getElementById('totalPoints'),
clearAllBtn: document.getElementById('clearAll'),
toggleCalculatorBtn: document.getElementById('toggleCalculator'),
calculator: document.getElementById('calculator'),
closeCalculatorBtn: document.getElementById('closeCalculator'),
printBtn: document.getElementById('printBtn'),
actualCostTotalElement: document.getElementById('actualCostTotal'),
mobileCountSpan: document.getElementById('mobileCount')
};

// Firebase ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ
const FirebaseDB = {
async getEquipmentCount() {
try {
const querySnapshot = await window.firestore.getDocs(
window.firestore.collection(window.db, 'welfare_equipment')
);
return querySnapshot.size;
} catch (error) {
console.error('ä»¶æ•°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
throw error;
}
},

async loadEquipment() {
try {
const q = window.firestore.query(
window.firestore.collection(window.db, 'welfare_equipment'),
window.firestore.orderBy('name')
);
const querySnapshot = await window.firestore.getDocs(q);
const equipment = [];
querySnapshot.forEach((doc) => {
equipment.push({
id: doc.id,
...doc.data()
});
});
return equipment;
} catch (error) {
console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
throw error;
}
},

async addEquipment(name, points, category = '', taisCode = '') {
try {
const docRef = await window.firestore.addDoc(
window.firestore.collection(window.db, 'welfare_equipment'),
{
name: name.trim(),
points: parseInt(points),
category: category.trim(),
taisCode: taisCode.trim(),
isActualCost: false, // å®Ÿè²»ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
createdAt: new Date()
}
);
return docRef.id;
} catch (error) {
console.error('ãƒ‡ãƒ¼ã‚¿è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
throw error;
}
},

async updateEquipment(id, name, points, category = '', taisCode = '', isActualCost = false) {
try {
await window.firestore.updateDoc(
window.firestore.doc(window.db, 'welfare_equipment', id),
{
name: name.trim(),
points: parseInt(points),
category: category.trim(),
taisCode: taisCode.trim(),
isActualCost: isActualCost,
updatedAt: new Date()
}
);
} catch (error) {
console.error('ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
throw error;
}
},

async deleteEquipment(id) {
try {
await window.firestore.deleteDoc(
window.firestore.doc(window.db, 'welfare_equipment', id)
);
} catch (error) {
console.error('ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
throw error;
}
},

async clearAllEquipment() {
try {
const q = window.firestore.query(
window.firestore.collection(window.db, 'welfare_equipment')
);
const querySnapshot = await window.firestore.getDocs(q);

const deletePromises = [];
querySnapshot.forEach((doc) => {
deletePromises.push(
window.firestore.deleteDoc(
window.firestore.doc(window.db, 'welfare_equipment', doc.id)
)
);
});

await Promise.all(deletePromises);
return querySnapshot.size;
} catch (error) {
console.error('å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
throw error;
}
}
};

// åˆæœŸåŒ–
async function initializeApp() {
try {
await loadEquipmentData();
await updateDatabaseCount(); // ä»¶æ•°ã‚’è¡¨ç¤º
showEmptySearchState();
loadSelectedItems();
} catch (error) {
showError('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
}
}

// ç¦ç¥‰ç”¨å…·ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
async function loadEquipmentData() {
try {
welfareEquipment = await FirebaseDB.loadEquipment();
filteredItems = welfareEquipment;
showInfo(`${welfareEquipment.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
} catch (error) {
throw error;
}
}

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä»¶æ•°ã®æ›´æ–°
async function updateDatabaseCount() {
try {
const count = await FirebaseDB.getEquipmentCount();
elements.dbCountSpan.textContent = `${count.toLocaleString()}ä»¶`;
} catch (error) {
elements.dbCountSpan.textContent = 'ã‚¨ãƒ©ãƒ¼';
console.error('ä»¶æ•°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
}
}

// é¸æŠæ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ ã®èª­ã¿è¾¼ã¿
function loadSelectedItems() {
try {
const saved = sessionStorage.getItem('selectedWelfareItems');
if (saved) {
selectedItems = JSON.parse(saved);
updateCalculator();
updateMobileCount();
}
} catch (error) {
selectedItems = [];
}
}

// é¸æŠæ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ ã®ä¿å­˜
function saveSelectedItems() {
try {
sessionStorage.setItem('selectedWelfareItems', JSON.stringify(selectedItems));
} catch (error) {
console.error('é¸æŠã‚¢ã‚¤ãƒ†ãƒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
}
}

// ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
elements.userModeBtn.addEventListener('click', () => switchMode(false));
elements.adminModeBtn.addEventListener('click', () => switchMode(true));

function switchMode(admin) {
isAdminMode = admin;
elements.userModeBtn.classList.toggle('active', !admin);
elements.adminModeBtn.classList.toggle('active', admin);
elements.adminPanel.classList.toggle('active', admin);

// æ¤œç´¢çµæœã‚’æ›´æ–°
if (elements.searchInput.value.trim()) {
performSearch(elements.searchInput.value);
} else {
showEmptySearchState();
}
}

// Excel ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
elements.fileInput.addEventListener('change', handleFileUpload);

async function handleFileUpload(e) {
const file = e.target.files[0];
if (!file) return;

try {
showInfo('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');

const arrayBuffer = await file.arrayBuffer();
const workbook = XLSX.read(arrayBuffer, { type: 'array' });
const firstSheetName = workbook.SheetNames[0];
const worksheet = workbook.Sheets[firstSheetName];
const data = XLSX.utils.sheet_to_json(worksheet, { header: ['name', 'points', 'category', 'taisCode'], range: 1 });

const validData = data
.filter(row => row.name && row.points)
.map(row => ({
name: String(row.name).trim(),
points: parseInt(row.points) || 0,
category: row.category ? String(row.category).trim() : '',
taisCode: row.taisCode ? String(row.taisCode).trim() : ''
}))
.filter(item => item.name && item.points > 0);

if (validData.length === 0) {
throw new Error('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
}

showInfo(`${validData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ä¸­...`);

// Firebase ã«ä¿å­˜ï¼ˆæœ€é«˜é€Ÿãƒãƒƒãƒå‡¦ç†ï¼‰
showInfo(`${validData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’é«˜é€Ÿä¿å­˜ä¸­...`);

try {
addedCount = await FirebaseDB.addBulkEquipment(validData);
} catch (error) {
console.error('é«˜é€Ÿä¿å­˜ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
showError('é«˜é€Ÿä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å€‹åˆ¥ä¿å­˜ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™...');

// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå€‹åˆ¥å‡¦ç†
addedCount = 0;
for (const item of validData) {
try {
await FirebaseDB.addEquipment(item.name, item.points, item.category, item.taisCode);
addedCount++;
if (addedCount % 100 === 0) {
showInfo(`${addedCount}/${validData.length}ä»¶ä¿å­˜å®Œäº†...`);
}
} catch (error) {
console.error(`"${item.name}" ã®ä¿å­˜ã«å¤±æ•—:`, error);
}
}
}

// ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
await loadEquipmentData();
await updateDatabaseCount(); // ä»¶æ•°ã‚‚æ›´æ–°
showEmptySearchState();

showSuccess(`${addedCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã—ã¾ã—ãŸ`);

} catch (error) {
console.error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
showError(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
} finally {
elements.fileInput.value = '';
}
}

// æ‰‹å‹•è¿½åŠ 
elements.addManualBtn.addEventListener('click', handleManualAdd);

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å…¨ã‚¯ãƒªã‚¢
elements.clearDatabaseBtn.addEventListener('click', handleClearDatabase);

// ä»¶æ•°æ›´æ–°
elements.refreshCountBtn.addEventListener('click', updateDatabaseCount);

async function handleClearDatabase() {
// äºŒé‡ç¢ºèªã§å®‰å…¨æ€§ã‚’é«˜ã‚ã‚‹
const firstConfirm = confirm('âš ï¸ è­¦å‘Š: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å…¨ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\n\næœ¬å½“ã«ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ');
if (!firstConfirm) return;

const secondConfirm = confirm('æœ€çµ‚ç¢ºèª: å…¨ã¦ã®ç¦ç¥‰ç”¨å…·ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚\n\nå‰Šé™¤ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ');
if (!secondConfirm) return;

try {
showInfo('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å…¨ã‚¯ãƒªã‚¢ä¸­...');
const deletedCount = await FirebaseDB.clearAllEquipment();

// ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚åˆæœŸåŒ–
welfareEquipment = [];
filteredItems = [];
selectedItems = [];

// ç”»é¢ã‚’æ›´æ–°
updateCalculator();
updateMobileCount();
saveSelectedItems();
showEmptySearchState();
elements.searchInput.value = '';
toggleClearButton('');
await updateDatabaseCount(); // ä»¶æ•°ã‚‚æ›´æ–°

showSuccess(`${deletedCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒç©ºã«ãªã‚Šã¾ã—ãŸã€‚`);

} catch (error) {
console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å…¨ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', error);
showError('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å…¨ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
}
}

async function handleManualAdd() {
const name = elements.manualName.value.trim();
const points = parseInt(elements.manualPoints.value);
const category = elements.manualCategory.value.trim();
const taisCode = elements.manualTaisCode.value.trim();

if (!name || !points || points <= 0) {
showError('å•†å“åã¨æœ‰åŠ¹ãªç‚¹æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
return;
}

try {
showInfo('ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ä¸­...');
await FirebaseDB.addEquipment(name, points, category, taisCode);
await loadEquipmentData();
await updateDatabaseCount(); // ä»¶æ•°ã‚‚æ›´æ–°

elements.manualName.value = '';
elements.manualPoints.value = '';
elements.manualCategory.value = '';
elements.manualTaisCode.value = '';
showSuccess(`"${name}" ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);

// æ¤œç´¢çµæœã‚’æ›´æ–°
if (elements.searchInput.value.trim()) {
performSearch(elements.searchInput.value);
} else {
showEmptySearchState();
}

} catch (error) {
console.error('æ‰‹å‹•è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
showError('ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
}
}

// æ¤œç´¢æ©Ÿèƒ½
elements.searchInput.addEventListener('input', (e) => {
const query = e.target.value.trim();
toggleClearButton(query);
if (query === '') {
showEmptySearchState();
} else {
performSearch(query);
}
});

// æ¤œç´¢ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
function toggleClearButton(query) {
if (query) {
elements.searchClearBtn.classList.add('visible');
} else {
elements.searchClearBtn.classList.remove('visible');
}
}

// æ¤œç´¢ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
elements.searchClearBtn.addEventListener('click', () => {
elements.searchInput.value = '';
elements.searchClearBtn.classList.remove('visible');
showEmptySearchState();
elements.searchInput.focus();
});

function performSearch(query) {
if (welfareEquipment.length === 0) {
showNoDataState();
return;
}

filteredItems = welfareEquipment.filter(item => 
item.name.toLowerCase().includes(query.toLowerCase())
);

displaySearchResults(filteredItems);
}

function displaySearchResults(items) {
if (items.length === 0) {
elements.searchResults.innerHTML = `
<div class="empty-state">
<h3>è©²å½“ã™ã‚‹å“ç›®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h3>
<p>åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã—ã¦ã¿ã¦ãã ã•ã„</p>
</div>
`;
return;
}

elements.searchResults.innerHTML = items.map(item => {
const selectedItem = selectedItems.find(selected => selected.id === item.id);
const isSelected = !!selectedItem;
const quantity = selectedItem ? selectedItem.quantity : 0;

const adminButtons = isAdminMode ? `
<button class="edit-btn" onclick="editItem('${item.id}', '${item.name.replace(/'/g, "\\'")}', ${item.points}, '${(item.category || '').replace(/'/g, "\\'")}', '${(item.taisCode || '').replace(/'/g, "\\'")}')">ç·¨é›†</button>
<button class="delete-btn" onclick="deleteItem('${item.id}', '${item.name.replace(/'/g, "\\'")}')">å‰Šé™¤</button>
` : '';

const categoryDisplay = item.category ? `<div class="item-category">å“ç›®: ${item.category}</div>` : '';
const taisCodeDisplay = item.taisCode ? `<div class="item-tais-code">taisã‚³ãƒ¼ãƒ‰: ${item.taisCode}</div>` : '';

return `
<div class="result-item">
<div class="item-info">
<div class="item-name">${item.name}</div>
<div class="item-points">${item.points}ç‚¹/æœˆ</div>
${categoryDisplay}
${taisCodeDisplay}
</div>
<div class="item-actions">
<button class="add-btn" onclick="addItem('${item.id}')">
${isSelected ? `è¿½åŠ æ¸ˆã¿ (${quantity}å€‹)` : 'è¿½åŠ '}
</button>
${adminButtons}
</div>
</div>
`;
}).join('');
}

// ã‚¢ã‚¤ãƒ†ãƒ æ“ä½œ
function addItem(itemId) {
const item = welfareEquipment.find(item => item.id === itemId);
if (!item) return;

const existingIndex = selectedItems.findIndex(selected => selected.id === itemId);
if (existingIndex !== -1) {
selectedItems[existingIndex].quantity += 1;
} else {
selectedItems.push({
...item,
quantity: 1
});
}

updateCalculator();
updateMobileCount();
saveSelectedItems();
displaySearchResults(filteredItems);
}

function updateQuantity(itemId, change) {
const itemIndex = selectedItems.findIndex(item => item.id === itemId);
if (itemIndex === -1) return;

selectedItems[itemIndex].quantity = Math.max(1, selectedItems[itemIndex].quantity + change);
updateCalculator();
updateMobileCount();
saveSelectedItems();
displaySearchResults(filteredItems);
}

function removeItem(itemId) {
selectedItems = selectedItems.filter(item => item.id !== itemId);
updateCalculator();
updateMobileCount();
saveSelectedItems();
displaySearchResults(filteredItems);
}

// å®Ÿè²»ãƒˆã‚°ãƒ«æ©Ÿèƒ½
async function toggleActualCost(itemId) {
const item = welfareEquipment.find(item => item.id === itemId);
if (!item) return;

const newActualCostState = !item.isActualCost;

try {
showInfo('å®Ÿè²»è¨­å®šã‚’æ›´æ–°ä¸­...');
await FirebaseDB.updateEquipment(
item.id, 
item.name, 
item.points, 
item.category, 
item.taisCode, 
newActualCostState
);
await loadEquipmentData();
await updateDatabaseCount();
performSearch(elements.searchInput.value || '');
showSuccess(`"${item.name}" ã®å®Ÿè²»è¨­å®šã‚’${newActualCostState ? 'ON' : 'OFF'}ã«ã—ã¾ã—ãŸ`);
} catch (error) {
console.error('å®Ÿè²»è¨­å®šæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
showError('å®Ÿè²»è¨­å®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
}
}

async function editItem(id, currentName, currentPoints, currentCategory = '', currentTaisCode = '', currentActualCost = false) {
const newName = prompt('å•†å“åã‚’ç·¨é›†:', currentName);
if (!newName || newName.trim() === '') return;

const newPoints = prompt('ç‚¹æ•°ã‚’ç·¨é›†:', currentPoints);
const points = parseInt(newPoints);
if (!points || points <= 0) return;

const newCategory = prompt('å“ç›®ã‚’ç·¨é›†:', currentCategory);
const category = newCategory !== null ? newCategory.trim() : '';

const newTaisCode = prompt('taisã‚³ãƒ¼ãƒ‰ã‚’ç·¨é›†:', currentTaisCode);
const taisCode = newTaisCode !== null ? newTaisCode.trim() : '';

const actualCostConfirm = confirm(`å®Ÿè²»å¯¾è±¡ã¨ã—ã¦è¨­å®šã—ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®è¨­å®š: ${currentActualCost ? 'ON (å®Ÿè²»å¯¾è±¡)' : 'OFF (ç‚¹æ•°å¯¾è±¡)'}`);

try {
showInfo('ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ä¸­...');
await FirebaseDB.updateEquipment(id, newName.trim(), points, category, taisCode, actualCostConfirm);
await loadEquipmentData();
await updateDatabaseCount();
performSearch(elements.searchInput.value);
showSuccess('ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
} catch (error) {
console.error('ç·¨é›†ã‚¨ãƒ©ãƒ¼:', error);
showError('ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
}
}

async function deleteItem(id, name) {
if (!confirm(`"${name}" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

try {
showInfo('ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ä¸­...');
await FirebaseDB.deleteEquipment(id);
await loadEquipmentData();
await updateDatabaseCount(); // ä»¶æ•°ã‚‚æ›´æ–°
performSearch(elements.searchInput.value);
showSuccess('ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
} catch (error) {
console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
showError('ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
}
}

// è¨ˆç®—æ©Ÿæ›´æ–°
function updateCalculator() {
// é€šå¸¸ã®ç‚¹æ•°è¨ˆç®—ï¼ˆå®Ÿè²»ä»¥å¤–ï¼‰
const normalPoints = selectedItems
.filter(item => !item.isActualCost)
.reduce((sum, item) => sum + (item.points * item.quantity), 0);

// å®Ÿè²»ã®åˆè¨ˆè¨ˆç®—
const actualCostTotal = selectedItems
.filter(item => item.isActualCost)
.reduce((sum, item) => sum + (item.points * item.quantity), 0);

// è¡¨ç¤ºæ›´æ–°
elements.totalPointsElement.textContent = `${normalPoints}ç‚¹`;

if (actualCostTotal > 0) {
elements.actualCostTotalElement.textContent = `${actualCostTotal.toLocaleString()}å††`;
elements.actualCostTotalElement.style.display = 'inline-block';
} else {
elements.actualCostTotalElement.style.display = 'none';
}

if (selectedItems.length === 0) {
elements.selectedItemsContainer.innerHTML = `
<div class="empty-state">
<p>é¸æŠã•ã‚ŒãŸå“ç›®ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
</div>
`;
} else {
elements.selectedItemsContainer.innerHTML = selectedItems.map((item, index) => {
const categoryDisplay = item.category ? `<div class="selected-item-category" style="color: #059669; font-size: 11px; font-weight: 600; margin-bottom: 3px;">å“ç›®: ${item.category}</div>` : '';
const taisCodeDisplay = item.taisCode ? `<div class="selected-item-tais" style="color: #d97706; font-size: 11px; font-weight: 500; margin-top: 2px;">taisã‚³ãƒ¼ãƒ‰: ${item.taisCode}</div>` : '';
const actualCostDisplay = item.isActualCost ? `<div class="selected-item-actual-cost" style="color: #dc2626; font-size: 10px; font-weight: 600; margin-top: 2px;">å®Ÿè²»å¯¾è±¡</div>` : '';

const pointsUnit = item.isActualCost ? 'å††' : 'ç‚¹';
const totalUnit = item.isActualCost ? 'å††' : 'ç‚¹';

return `
<div class="selected-item" draggable="true" data-index="${index}" data-item-id="${item.id}">
<div class="drag-handle">â‹®â‹®</div>
<div class="selected-item-info">
${categoryDisplay}
<div class="selected-item-name">${item.name}</div>
<div class="selected-item-points">${item.points}${pointsUnit}/æœˆ Ã— ${item.quantity} = ${item.points * item.quantity}${totalUnit}</div>
${taisCodeDisplay}
${actualCostDisplay}
</div>
<div class="quantity-controls">
<button class="quantity-btn" onclick="updateQuantity('${item.id}', -1)" ${item.quantity <= 1 ? 'disabled' : ''}>âˆ’</button>
<div class="quantity-display">${item.quantity}</div>
<button class="quantity-btn" onclick="updateQuantity('${item.id}', 1)">+</button>
</div>
<button class="remove-btn" onclick="removeItem('${item.id}')">Ã—</button>
</div>
`;
}).join('');

// åˆè¨ˆè¡¨ç¤ºã‚’è¿½åŠ 
const totalAmount = actualCostTotal + normalPoints;
let summaryHTML = '<div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e5e7eb;">';
summaryHTML += '<div style="text-align: center; font-weight: 600; margin-bottom: 10px; color: #374151;">åˆè¨ˆ</div>';
summaryHTML += `<div style="text-align: center; font-size: 18px; font-weight: 700; color: #1e293b;">`;
summaryHTML += `${totalAmount.toLocaleString()}å††`;
summaryHTML += `</div>`;
summaryHTML += '</div>';

elements.selectedItemsContainer.innerHTML += summaryHTML;

// ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
setupDragAndDrop();
}
}

function updateMobileCount() {
const totalItems = selectedItems.reduce((sum, item) => sum + item.quantity, 0);
elements.mobileCountSpan.textContent = totalItems;
}

// ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
function setupDragAndDrop() {
const selectedItemElements = elements.selectedItemsContainer.querySelectorAll('.selected-item');
let draggedElement = null;
let draggedIndex = null;

selectedItemElements.forEach((element, index) => {
element.addEventListener('dragstart', (e) => {
draggedElement = element;
draggedIndex = parseInt(element.dataset.index);
element.classList.add('dragging');
e.dataTransfer.effectAllowed = 'move';
e.dataTransfer.setData('text/html', element.outerHTML);
});

element.addEventListener('dragend', (e) => {
element.classList.remove('dragging');
draggedElement = null;
draggedIndex = null;
});

element.addEventListener('dragover', (e) => {
e.preventDefault();
e.dataTransfer.dropEffect = 'move';
});

element.addEventListener('dragenter', (e) => {
e.preventDefault();
if (element !== draggedElement) {
element.classList.add('drag-over');
}
});

element.addEventListener('dragleave', (e) => {
element.classList.remove('drag-over');
});

element.addEventListener('drop', (e) => {
e.preventDefault();
element.classList.remove('drag-over');

if (draggedElement && element !== draggedElement) {
const targetIndex = parseInt(element.dataset.index);

// ã‚¢ã‚¤ãƒ†ãƒ ã®é †åºã‚’å¤‰æ›´
reorderSelectedItems(draggedIndex, targetIndex);
}
});
});
}

// é¸æŠã‚¢ã‚¤ãƒ†ãƒ ã®é †åºå¤‰æ›´
function reorderSelectedItems(fromIndex, toIndex) {
if (fromIndex === toIndex) return;

// é…åˆ—ã‹ã‚‰è¦ç´ ã‚’ç§»å‹•
const movedItem = selectedItems.splice(fromIndex, 1)[0];
selectedItems.splice(toIndex, 0, movedItem);

// ç”»é¢ã‚’æ›´æ–°
updateCalculator();
updateMobileCount();
saveSelectedItems();
}

// å…¨å‰Šé™¤
elements.clearAllBtn.addEventListener('click', () => {
selectedItems = [];
updateCalculator();
updateMobileCount();
saveSelectedItems();
displaySearchResults(filteredItems);
});

// ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
elements.toggleCalculatorBtn.addEventListener('click', () => {
elements.calculator.classList.add('show');
elements.closeCalculatorBtn.style.display = 'block';
});

elements.closeCalculatorBtn.addEventListener('click', () => {
elements.calculator.classList.remove('show');
elements.closeCalculatorBtn.style.display = 'none';
});

// PDFå°åˆ·æ©Ÿèƒ½
elements.printBtn.addEventListener('click', generatePDF);

// PDFç”Ÿæˆé–¢æ•°
async function generatePDF() {
if (selectedItems.length === 0) {
alert('å°åˆ·ã™ã‚‹å“ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšç¦ç¥‰ç”¨å…·ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
return;
}

try {
elements.printBtn.disabled = true;
elements.printBtn.textContent = 'ç”Ÿæˆä¸­...';

// å°åˆ·ç”¨ã®HTMLã‚’ä½œæˆ
const printContent = createPrintHTML();

// å°åˆ·ç”¨ã®è¦ç´ ã‚’ä¸€æ™‚çš„ã«DOMã«è¿½åŠ 
const printElement = document.createElement('div');
printElement.innerHTML = printContent;
printElement.style.position = 'absolute';
printElement.style.left = '-9999px';
printElement.style.top = '0';
printElement.style.width = '794px'; // A4ã‚µã‚¤ã‚ºã®å¹…ï¼ˆpxï¼‰
printElement.style.backgroundColor = 'white';
printElement.style.padding = '40px';
printElement.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
document.body.appendChild(printElement);

// html2canvasã§ç”»åƒã«å¤‰æ›
const canvas = await html2canvas(printElement, {
  scale: 1.5, // è§£åƒåº¦ã‚’ä¸‹ã’ã¦å®¹é‡å‰Šæ¸›ï¼ˆ2 â†’ 1.5ï¼‰
  useCORS: true,
  backgroundColor: '#ffffff',
  width: 794,
  // height: 1123 ã®è¡Œã‚’å‰Šé™¤ï¼ˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®é«˜ã•ã«è‡ªå‹•èª¿æ•´ï¼‰
  allowTaint: true,
  logging: false // ãƒ­ã‚°å‡ºåŠ›ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
});

// ä¸€æ™‚çš„ãªè¦ç´ ã‚’å‰Šé™¤
document.body.removeChild(printElement);

// ç”»åƒã‚’åœ§ç¸®ï¼ˆJPEGã§å®¹é‡å‰Šæ¸›ï¼‰
const tempCanvas = document.createElement('canvas');
const tempCtx = tempCanvas.getContext('2d');
tempCanvas.width = canvas.width;
tempCanvas.height = canvas.height;

// ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«åŒ–ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ - ã•ã‚‰ã«å®¹é‡å‰Šæ¸›ã—ãŸã„å ´åˆï¼‰
const shouldUseGrayscale = false; // ã‚«ãƒ©ãƒ¼ã‚’ä¿æŒ

if (shouldUseGrayscale) {
// ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«å‡¦ç†
tempCtx.filter = 'grayscale(100%)';
tempCtx.drawImage(canvas, 0, 0);
} else {
// ã‚«ãƒ©ãƒ¼ã®ã¾ã¾
tempCtx.drawImage(canvas, 0, 0);
}

// jsPDFã§PDFä½œæˆ
const { jsPDF } = window.jspdf;
const pdf = new jsPDF('p', 'mm', 'a4');

// åœ§ç¸®ã•ã‚ŒãŸJPEGç”»åƒã¨ã—ã¦å–å¾—ï¼ˆå“è³ªã‚’èª¿æ•´ã—ã¦å®¹é‡å‰Šæ¸›ï¼‰
const imgData = tempCanvas.toDataURL('image/jpeg', 0.7); // å“è³ª70%ã§åœ§ç¸®
const imgWidth = 210; // A4ã®å¹…ï¼ˆmmï¼‰
const pageHeight = 297; // A4ã®é«˜ã•ï¼ˆmmï¼‰
const imgHeight = (canvas.height * imgWidth) / canvas.width;

let heightLeft = imgHeight;
let position = 0;

// æœ€åˆã®ãƒšãƒ¼ã‚¸ã‚’è¿½åŠ ï¼ˆåœ§ç¸®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight, undefined, 'MEDIUM'); // åœ§ç¸®ãƒ¬ãƒ™ãƒ«æŒ‡å®š
heightLeft -= pageHeight;
position -= pageHeight;

// æ®‹ã‚Šã®é«˜ã•ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ
while (heightLeft > 0) {  // â† 10 ã‚’ 0 ã«å¤‰æ›´
  pdf.addPage();
  pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight, undefined, 'MEDIUM');
  heightLeft -= pageHeight;
  position -= pageHeight;
}

// ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
      const currentDate = new Date().toLocaleDateString('ja-JP');
      const filename = `ç¦ç¥‰ç”¨å…·ãƒ¬ãƒ³ã‚¿ãƒ«æ¬å…¥å®Œäº†æ›¸_${currentDate.replace(/\//g, '')}.pdf`;

// PDFä¿å­˜
pdf.save(filename);

} catch (error) {
console.error('PDFç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
alert('PDFç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ãŒå¯¾å¿œã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
} finally {
elements.printBtn.disabled = false;
elements.printBtn.innerHTML = 'ğŸ“„ å°åˆ·';
}
}

// å°åˆ·ç”¨HTMLä½œæˆé–¢æ•°
function createPrintHTML() {
const currentDate = new Date().toLocaleDateString('ja-JP');

// é€šå¸¸ã®ç‚¹æ•°è¨ˆç®—ï¼ˆå®Ÿè²»ä»¥å¤–ï¼‰
const normalPoints = selectedItems
.filter(item => !item.isActualCost)
.reduce((sum, item) => sum + (item.points * item.quantity), 0);

// å®Ÿè²»ã®åˆè¨ˆè¨ˆç®—
const actualCostTotal = selectedItems
.filter(item => item.isActualCost)
.reduce((sum, item) => sum + (item.points * item.quantity), 0);

// ç·åˆè¨ˆï¼ˆå††å˜ä½ï¼‰
const totalAmount = actualCostTotal + normalPoints;

let itemsHTML = '';
selectedItems.forEach((item, index) => {
const itemTotal = item.points * item.quantity;
const categoryDisplay = item.category ? item.category : '';
const taisDisplay = item.taisCode ? `<div style="color: #d97706; font-size: 12px; margin-top: 5px;">taisã‚³ãƒ¼ãƒ‰: ${item.taisCode}</div>` : '';
const actualCostLabel = item.isActualCost ? `<div style="color: #dc2626; font-size: 11px; font-weight: 600; margin-top: 3px;">å®Ÿè²»å¯¾è±¡</div>` : '';

// å˜ä½ã‚’å®Ÿè²»ã‹ã©ã†ã‹ã§å¤‰æ›´
const unit = item.isActualCost ? 'å††' : 'ç‚¹';
    
itemsHTML += `
<tr style="border-bottom: 1px solid #e5e7eb;">
<td style="padding: 12px; text-align: center; border-right: 1px solid #e5e7eb;">${index + 1}</td>
<td style="padding: 12px; border-right: 1px solid #e5e7eb;">
<div style="font-weight: 600;">${categoryDisplay}</div>
</td>
<td style="padding: 12px; border-right: 1px solid #e5e7eb;">
<div style="font-weight: 600; margin-bottom: 5px;">${item.name}</div>
${taisDisplay}
${actualCostLabel}
</td>
<td style="padding: 12px; text-align: center; border-right: 1px solid #e5e7eb;">${item.points}${unit}</td>
<td style="padding: 12px; text-align: center; border-right: 1px solid #e5e7eb;">${item.quantity}</td>
<td style="padding: 12px; text-align: center; font-weight: 600;">${itemTotal}${unit}</td>
</tr>
`;
});

// å³ä¸Šã®åˆè¨ˆè¡¨ç¤ºï¼ˆç‚¹æ•°ã¨å®Ÿè²»ã‚’åˆ†ã‘ã¦è¡¨ç¤ºï¼‰
let topSummaryHTML = '';
if (normalPoints > 0 && actualCostTotal > 0) {
topSummaryHTML = `åˆè¨ˆç‚¹æ•°: ${normalPoints.toLocaleString()}ç‚¹ / å®Ÿè²»: ${actualCostTotal.toLocaleString()}å††`;
} else if (normalPoints > 0) {
topSummaryHTML = `åˆè¨ˆç‚¹æ•°: ${normalPoints.toLocaleString()}ç‚¹`;
} else if (actualCostTotal > 0) {
topSummaryHTML = `å®Ÿè²»åˆè¨ˆ: ${actualCostTotal.toLocaleString()}å††`;
}

return `
<div style="max-width: 714px; margin: 0 auto; background: white;">
<div style="text-align: center; margin-bottom: 30px;">
<h1 style="font-size: 24px; font-weight: bold; color: #1e293b; margin: 0;">ç¦ç¥‰ç”¨å…·ãƒ¬ãƒ³ã‚¿ãƒ«æ¬å…¥å®Œäº†æ›¸</h1>
</div>

<div style="display: flex; justify-content: space-between; margin-bottom: 30px; font-size: 14px; color: #6b7280;">
<div>ä½œæˆæ—¥: ${currentDate}</div>
<div style="font-weight: 600; color: #2563eb;">${topSummaryHTML}</div>
</div>

<table style="width: 100%; border-collapse: collapse; border: 2px solid #374151; font-size: 14px;">
<thead>
<tr style="background: #f8fafc; border-bottom: 2px solid #374151;">
<th style="padding: 12px; text-align: center; border-right: 1px solid #374151; font-weight: bold;">No.</th>
<th style="padding: 12px; text-align: center; border-right: 1px solid #374151; font-weight: bold;">å“ç›®</th>
<th style="padding: 12px; text-align: center; border-right: 1px solid #374151; font-weight: bold;">å•†å“å</th>
<th style="padding: 12px; text-align: center; border-right: 1px solid #374151; font-weight: bold;">å˜ä¾¡</th>
<th style="padding: 12px; text-align: center; border-right: 1px solid #374151; font-weight: bold;">æ•°é‡</th>
<th style="padding: 12px; text-align: center; font-weight: bold;">åˆè¨ˆ</th>
</tr>
</thead>
<tbody>
${itemsHTML}
</tbody>
</table>

<div style="text-align: right; margin-top: 20px; padding-top: 20px; border-top: 2px solid #374151;">
<div style="font-size: 18px; font-weight: bold; color: #1e293b; margin-bottom: 30px;">
ç·åˆè¨ˆ: ${totalAmount.toLocaleString()}å††
</div>
<div style="font-size: 14px; color: #374151; line-height: 2;">
<div style="margin-bottom: 10px;">
åˆ©ç”¨è€…ç½²åã€€<span style="display: inline-block; border-bottom: 1px solid #374151; width: 300px; margin-left: 10px;"></span>
</div>
<div>
ä»£ç­†è€…åã€€ã€€<span style="display: inline-block; border-bottom: 1px solid #374151; width: 300px; margin-left: 10px;"></span>
</div>
</div>
</div>

<div style="text-align: center; margin-top: 40px; font-size: 12px; color: #9ca3af;">
ç¦ç¥‰ç”¨å…·ç‚¹æ•°è¨ˆç®—ã‚¢ãƒ—ãƒªã§ä½œæˆ
</div>

</div>
`;
}

// çŠ¶æ…‹è¡¨ç¤ºé–¢æ•°
function showEmptySearchState() {
elements.searchResults.innerHTML = `
<div class="empty-state">
<h3>ç¦ç¥‰ç”¨å…·ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„</h3>
<p>å“ç›®åã‚’å…¥åŠ›ã™ã‚‹ã¨æ¤œç´¢çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
</div>
`;
}

function showNoDataState() {
elements.searchResults.innerHTML = `
<div class="empty-state">
<h3>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h3>
<p>ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
</div>
`;
}

function showInfo(message) {
elements.adminStatus.innerHTML = `<div class="status-message status-info">${message}</div>`;
setTimeout(clearStatus, 3000);
}

function showSuccess(message) {
elements.adminStatus.innerHTML = `<div class="status-message status-success">${message}</div>`;
setTimeout(clearStatus, 5000);
}

function showError(message) {
elements.adminStatus.innerHTML = `<div class="status-message status-error">${message}</div>`;
setTimeout(clearStatus, 8000);
}

function clearStatus() {
elements.adminStatus.innerHTML = '';
}

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
window.addEventListener('load', () => {
// Firebase ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å°‘ã—å¾…ã¤
setTimeout(initializeApp, 1000);
});
</script>
</body>
</html>
