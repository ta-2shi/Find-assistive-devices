<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ç¦ç¥‰ç”¨å…·è¨ˆç®—">
<meta name="theme-color" content="#2563eb">
<title>ç¦ç¥‰ç”¨å…·ç‚¹æ•°è¨ˆç®—ã‚¢ãƒ—ãƒª</title>

<!-- PWA Manifest -->
<link rel="manifest" data-href="data:application/json;base64,eyJuYW1lIjoi56aP56WJ55So5YW36KGA5pWw6KiI566XIiwic2hvcnRfbmFtZSI6IuemjeWJqeS4g+OAhue2muOAhyIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInRoZW1lX2NvbG9yIjoiIzI1NjNlYiIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1USTRJaUJvWldsbmFIUTlJakV5T0NJZ2RtbGxkMEp2ZUQwaU1DQXdJREV5T0NBeE1qZ2lJRlpsY25OcGIyNDlJakV1TVNJZ2VHMXNibk05SW1oMGRIQTZMeTkzZDNjdWR6TXViM0puTHpJd01EQXZjM1puSWo0S0lDQWdQSEpsWTNRZ2QybGtkR2c5SWpFeU9DSWdhR1ZwWjJoMFBTSXhNamdpSUhKNFBTSTJJaUJtYVd4c1BTSWpNalUyTTJWaUlpOCtDaUFnSUNBOGNtVmpkQ0IzYVdSMGFEMGlNVEU0SWlCb1pXbG5hSFE5SWpFeE9DSWdlRDBpTlNJZ2VUMGlOU0lnY25nOUlqWWlJR1pwYkd3OUlpTm1abVptWm1ZaUx6NEtJQ0E4TDNOMlp6NEsiLCJzaXplcyI6IjEyOHgxMjgiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">

<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
min-height: 100vh;
padding: env(safe-area-inset-top, 0) env(safe-area-inset-right, 0) env(safe-area-inset-bottom, 0) env(safe-area-inset-left, 0);
}

.container {
max-width: 1200px;
margin: 0 auto;
padding: 20px;
min-height: 100vh;
display: flex;
flex-direction: column;
}

.header {
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(10px);
border-radius: 16px;
padding: 20px;
margin-bottom: 20px;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.title {
font-size: 24px;
font-weight: 700;
color: #1e293b;
margin-bottom: 16px;
text-align: center;
}

.search-container {
position: relative;
margin-bottom: 20px;
}

.search-input {
width: 100%;
padding: 16px 20px;
border: none;
border-radius: 12px;
background: rgba(255, 255, 255, 0.9);
font-size: 16px;
box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
transition: all 0.3s ease;
}

.file-upload-container {
margin-bottom: 20px;
padding: 20px;
background: rgba(255, 255, 255, 0.1);
border-radius: 12px;
border: 2px dashed rgba(255, 255, 255, 0.3);
text-align: center;
transition: all 0.3s ease;
}

.file-upload-container:hover {
border-color: rgba(255, 255, 255, 0.5);
background: rgba(255, 255, 255, 0.15);
}

.file-input {
display: none;
}

.file-upload-btn {
background: linear-gradient(45deg, #10b981, #059669);
color: white;
border: none;
padding: 12px 24px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
margin-bottom: 8px;
}

.file-upload-text {
color: rgba(255, 255, 255, 0.8);
font-size: 14px;
}

.upload-status {
margin-top: 12px;
padding: 8px 16px;
border-radius: 6px;
font-size: 14px;
font-weight: 600;
}

.upload-success {
background: #dcfce7;
color: #166534;
}

.upload-error {
background: #fecaca;
color: #991b1b;
}

.search-input:focus {
outline: none;
box-shadow: 0 4px 24px rgba(37, 99, 235, 0.2);
transform: translateY(-2px);
}

.main-content {
display: grid;
grid-template-columns: 1fr;
gap: 20px;
flex: 1;
}

@media (min-width: 768px) {
.main-content {
grid-template-columns: 1fr 400px;
}
}

.search-results {
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(10px);
border-radius: 16px;
padding: 20px;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
max-height: 600px;
overflow-y: auto;
}

.result-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 16px;
background: rgba(255, 255, 255, 0.7);
border-radius: 12px;
margin-bottom: 12px;
transition: all 0.3s ease;
}

.result-item:hover {
transform: translateY(-2px);
box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.item-info {
flex: 1;
}

.item-name {
font-weight: 600;
color: #1e293b;
margin-bottom: 4px;
}

.item-points {
color: #6b7280;
font-size: 14px;
}

.add-btn {
background: linear-gradient(45deg, #10b981, #059669);
color: white;
border: none;
padding: 8px 16px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
transition: all 0.3s ease;
}

.add-btn:hover {
transform: scale(1.05);
}

.add-btn:disabled {
background: #d1d5db;
cursor: not-allowed;
transform: none;
}

.calculator {
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(10px);
border-radius: 16px;
padding: 20px;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
position: sticky;
top: 20px;
max-height: 80vh;
display: flex;
flex-direction: column;
}

.calculator-title {
font-size: 20px;
font-weight: 700;
color: #1e293b;
margin-bottom: 16px;
display: flex;
justify-content: space-between;
align-items: center;
}

.total-points {
background: linear-gradient(45deg, #2563eb, #1d4ed8);
color: white;
padding: 4px 12px;
border-radius: 20px;
font-size: 16px;
}

.selected-items {
flex: 1;
overflow-y: auto;
margin-bottom: 16px;
}

.selected-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 12px;
background: rgba(255, 255, 255, 0.7);
border-radius: 8px;
margin-bottom: 8px;
}

.selected-item-info {
flex: 1;
}

.selected-item-name {
font-weight: 600;
color: #1e293b;
font-size: 14px;
margin-bottom: 2px;
}

.selected-item-points {
color: #6b7280;
font-size: 12px;
}

.remove-btn {
background: #ef4444;
color: white;
border: none;
width: 24px;
height: 24px;
border-radius: 50%;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
font-size: 12px;
transition: all 0.3s ease;
}

.remove-btn:hover {
transform: scale(1.1);
}

.clear-btn {
width: 100%;
background: #6b7280;
color: white;
border: none;
padding: 12px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
transition: all 0.3s ease;
}

.clear-btn:hover {
background: #4b5563;
}

.empty-state {
text-align: center;
color: #6b7280;
padding: 40px 20px;
}

.mobile-toggle {
display: none;
background: linear-gradient(45deg, #2563eb, #1d4ed8);
color: white;
border: none;
padding: 12px 24px;
border-radius: 12px;
cursor: pointer;
font-weight: 600;
margin-bottom: 20px;
position: sticky;
top: 0;
z-index: 10;
}

@media (max-width: 767px) {
.mobile-toggle {
display: block;
}

.calculator {
display: none;
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
z-index: 100;
max-height: 100vh;
border-radius: 0;
margin: 0;
}

.calculator.show {
display: flex;
}

.close-btn {
background: #6b7280;
color: white;
border: none;
padding: 8px 16px;
border-radius: 8px;
cursor: pointer;
font-size: 14px;
margin-bottom: 16px;
}
}

.share-container {
background: rgba(255, 255, 255, 0.1);
border-radius: 12px;
padding: 20px;
margin-bottom: 20px;
border: 1px solid rgba(255, 255, 255, 0.2);
}

.share-section h3 {
color: white;
font-size: 18px;
margin-bottom: 16px;
text-align: center;
}

.share-buttons {
display: flex;
gap: 12px;
justify-content: center;
margin-bottom: 16px;
flex-wrap: wrap;
}

.share-btn {
background: linear-gradient(45deg, #3b82f6, #2563eb);
color: white;
border: none;
padding: 10px 20px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
font-size: 14px;
transition: all 0.3s ease;
}

.share-btn:hover:not(:disabled) {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.share-btn:disabled {
background: #6b7280;
cursor: not-allowed;
transform: none;
}

.share-btn.secondary {
background: linear-gradient(45deg, #6b7280, #4b5563);
}

.share-btn.secondary:hover {
box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
}

.share-btn.small {
padding: 6px 12px;
font-size: 12px;
}

.share-code-display {
background: rgba(255, 255, 255, 0.9);
border-radius: 8px;
padding: 16px;
text-align: center;
}

.share-code {
font-family: 'Monaco', 'Consolas', monospace;
font-size: 18px;
font-weight: 700;
color: #1e293b;
background: #f8fafc;
padding: 12px 16px;
border-radius: 6px;
border: 2px dashed #3b82f6;
display: inline-block;
margin: 8px 0;
letter-spacing: 2px;
}

.share-code-info {
font-size: 14px;
color: #6b7280;
margin-top: 8px;
}

.copy-btn {
background: #10b981;
color: white;
border: none;
padding: 8px 16px;
border-radius: 6px;
cursor: pointer;
font-size: 14px;
margin-top: 8px;
transition: all 0.3s ease;
}

.copy-btn:hover {
background: #059669;
}

.load-code-input {
background: rgba(255, 255, 255, 0.9);
border-radius: 8px;
padding: 16px;
}

.load-code-input input {
width: 100%;
padding: 12px;
border: 2px solid #e5e7eb;
border-radius: 6px;
font-size: 16px;
text-align: center;
margin-bottom: 12px;
letter-spacing: 1px;
text-transform: uppercase;
}

.load-code-input input:focus {
outline: none;
border-color: #3b82f6;
}

.load-code-input .share-buttons {
margin-bottom: 0;
}

.hidden {
display: none !important;
}

@media (max-width: 767px) {
.share-buttons {
flex-direction: column;
align-items: center;
}

.share-btn {
width: 200px;
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1 class="title">ç¦ç¥‰ç”¨å…·ç‚¹æ•°è¨ˆç®—ã‚¢ãƒ—ãƒª</h1>

<div class="file-upload-container">
<input type="file" class="file-input" id="fileInput" accept=".xlsx,.xls">
<button class="file-upload-btn" onclick="document.getElementById('fileInput').click()">
Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
</button>
<div class="file-upload-text">
ç¦ç¥‰ç”¨å…·ãƒªã‚¹ãƒˆï¼ˆAåˆ—ï¼šå•†å“åã€Båˆ—ï¼šç‚¹æ•°ï¼‰
</div>
<div id="uploadStatus"></div>
</div>

<div class="search-container">
<input type="text" class="search-input" id="searchInput" placeholder="ç¦ç¥‰ç”¨å…·ã‚’æ¤œç´¢...">
</div>
</div>

<button class="mobile-toggle" id="toggleCalculator">
è¨ˆç®—çµæœã‚’è¡¨ç¤º (<span id="mobileCount">0</span>ä»¶)
</button>

<div class="main-content">
<div class="search-results" id="searchResults">
<div class="empty-state">
<h3>ç¦ç¥‰ç”¨å…·ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„</h3>
<p>å“ç›®åã‚’å…¥åŠ›ã™ã‚‹ã¨æ¤œç´¢çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
</div>
</div>

<div class="calculator" id="calculator">
<button class="close-btn" id="closeCalculator" style="display: none;">Ã— é–‰ã˜ã‚‹</button>
<div class="calculator-title">
é¸æŠã—ãŸå“ç›®
<span class="total-points" id="totalPoints">0ç‚¹</span>
</div>
<div class="selected-items" id="selectedItems">
<div class="empty-state">
<p>é¸æŠã•ã‚ŒãŸå“ç›®ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
</div>
</div>
<button class="clear-btn" id="clearAll">å…¨ã¦å‰Šé™¤</button>
</div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// ç¦ç¥‰ç”¨å…·ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆåˆæœŸã¯ç©ºï¼‰
let welfareEquipment = [];
let selectedItems = [];
let filteredItems = [];

const fileInput = document.getElementById('fileInput');
const uploadStatus = document.getElementById('uploadStatus');
const shareCodeDisplay = document.getElementById('shareCodeDisplay');
const loadCodeInput = document.getElementById('loadCodeInput');
const generateShareCodeBtn = document.getElementById('generateShareCode');
const loadFromCodeBtn = document.getElementById('loadFromCode');
const shareCodeInput = document.getElementById('shareCodeInput');
const loadDataBtn = document.getElementById('loadDataBtn');
const cancelLoadBtn = document.getElementById('cancelLoadBtn');
const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');
const selectedItemsContainer = document.getElementById('selectedItems');
const totalPointsElement = document.getElementById('totalPoints');
const clearAllBtn = document.getElementById('clearAll');
const toggleCalculatorBtn = document.getElementById('toggleCalculator');
const calculator = document.getElementById('calculator');
const closeCalculatorBtn = document.getElementById('closeCalculator');
const mobileCountSpan = document.getElementById('mobileCount');

// ãƒ‡ãƒ¼ã‚¿å…±æœ‰ç”¨ã®ç°¡æ˜“APIï¼ˆJSONBinã‚’ä½¿ç”¨ï¼‰
const JSONBIN_BASE_URL = 'https://api.jsonbin.io/v3/b';

// ãƒ©ãƒ³ãƒ€ãƒ ãªå…±æœ‰ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
function generateRandomCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < 8; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

// ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜
async function shareData(data) {
    try {
        const shareCode = generateRandomCode();
        const payload = {
            code: shareCode,
            data: data,
            timestamp: new Date().toISOString(),
            version: '1.0'
        };

        const response = await fetch(JSONBIN_BASE_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Master-Key': '$2a$10$8K0KqzgFwJ1rHxB/KcVZOew7Nq5ZFJ8V8J8V8J8V8J8V8J8V8J' // ãƒ€ãƒŸãƒ¼ã‚­ãƒ¼
            },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            const result = await response.json();
            return { success: true, shareCode: shareCode, binId: result.metadata.id };
        } else {
            throw new Error('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        console.error('å…±æœ‰ã‚¨ãƒ©ãƒ¼:', error);
        return { success: false, error: error.message };
    }
}

// å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆç°¡æ˜“ç‰ˆ - ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ™ãƒ¼ã‚¹ï¼‰
function shareDataLocal(data) {
    try {
        const shareCode = generateRandomCode();
        const sharedData = {
            code: shareCode,
            data: data,
            timestamp: new Date().toISOString()
        };
        
        // ç°¡æ˜“çš„ã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼ˆå®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§ã¯å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ï¼‰
        localStorage.setItem(`shared_${shareCode}`, JSON.stringify(sharedData));
        
        return { success: true, shareCode: shareCode };
    } catch (error) {
        return { success: false, error: error.message };
    }
}

// å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
function loadDataFromCode(shareCode) {
    try {
        const key = `shared_${shareCode.toUpperCase()}`;
        const sharedData = localStorage.getItem(key);
        
        if (sharedData) {
            const parsed = JSON.parse(sharedData);
            return { success: true, data: parsed.data, timestamp: parsed.timestamp };
        } else {
            return { success: false, error: 'ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' };
        }
    } catch (error) {
        return { success: false, error: 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ' };
    }
}
// åˆæœŸåŒ–ï¼šä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
function loadSavedData() {
    try {
        const savedData = JSON.parse(localStorage.getItem('welfareEquipmentData') || 'null');
        if (savedData && Array.isArray(savedData) && savedData.length > 0) {
            welfareEquipment = savedData;
            filteredItems = welfareEquipment;
            showDataStatus(`ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ${savedData.length}ä»¶ï¼‰`);
            updateShareButton();
            return true;
        }
    } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    }
    updateShareButton();
    return false;
}

// ãƒ‡ãƒ¼ã‚¿ä¿å­˜
function saveData(data) {
    try {
        localStorage.setItem('welfareEquipmentData', JSON.stringify(data));
        localStorage.setItem('welfareEquipmentTimestamp', new Date().toISOString());
        updateShareButton();
    } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
    }
}

// å…±æœ‰ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
function updateShareButton() {
    if (welfareEquipment.length > 0) {
        generateShareCodeBtn.disabled = false;
    } else {
        generateShareCodeBtn.disabled = true;
    }
}

// ãƒ‡ãƒ¼ã‚¿çŠ¶æ³è¡¨ç¤º
function showDataStatus(message) {
    const timestamp = localStorage.getItem('welfareEquipmentTimestamp');
    let timeText = '';
    if (timestamp) {
        const date = new Date(timestamp);
        timeText = ` (æ›´æ–°: ${date.toLocaleString('ja-JP')})`;
    }
    
    uploadStatus.innerHTML = `<div class="upload-status upload-success">${message}${timeText}</div>`;
    setTimeout(() => {
        uploadStatus.innerHTML = '';
    }, 5000);
}

// åˆå›è¡¨ç¤ºã®è¨­å®š
function initializeApp() {
    if (loadSavedData()) {
        // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯æ¤œç´¢å¯èƒ½çŠ¶æ…‹
        showEmptySearchState();
    } else {
        // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾…ã¡çŠ¶æ…‹
        showNoDataState();
    }
}

function showEmptySearchState() {
    searchResults.innerHTML = `
        <div class="empty-state">
            <h3>ç¦ç¥‰ç”¨å…·ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„</h3>
            <p>å“ç›®åã‚’å…¥åŠ›ã™ã‚‹ã¨æ¤œç´¢çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>
    `;
}

function showNoDataState() {
    searchResults.innerHTML = `
        <div class="empty-state">
            <h3>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h3>
            <p>ã¾ãšä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>
            <p>ï¼ˆAåˆ—ï¼šå•†å“åã€Båˆ—ï¼šç‚¹æ•°ã®å½¢å¼ï¼‰</p>
        </div>
    `;
}

// Excelãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æ©Ÿèƒ½
fileInput.addEventListener('change', async (e) => {
const file = e.target.files[0];
if (!file) return;

try {
uploadStatus.innerHTML = '<div class="upload-status">èª­ã¿è¾¼ã¿ä¸­...</div>';

const arrayBuffer = await file.arrayBuffer();
const workbook = XLSX.read(arrayBuffer, { type: 'array' });
const firstSheetName = workbook.SheetNames[0];
const worksheet = workbook.Sheets[firstSheetName];
const data = XLSX.utils.sheet_to_json(worksheet, { header: ['name', 'points'], range: 1 });

// ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦å¤‰æ›
const newEquipment = data
.filter(row => row.name && row.points) // ç©ºã®è¡Œã‚’é™¤å¤–
.map((row, index) => ({
id: Date.now() + index, // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã‚’ç”Ÿæˆ
name: String(row.name).trim(),
points: parseInt(row.points) || 0
}))
.filter(item => item.name !== '' && item.points > 0); // æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã®ã¿

if (newEquipment.length === 0) {
throw new Error('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
}

// ç¦ç¥‰ç”¨å…·ãƒªã‚¹ãƒˆã‚’æ›´æ–°
welfareEquipment = newEquipment;
filteredItems = welfareEquipment;

// é¸æŠæ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªã‚¢ï¼ˆIDãŒå¤‰ã‚ã‚‹ãŸã‚ï¼‰
selectedItems = [];
updateCalculator();
updateMobileCount();

// æ¤œç´¢çµæœã‚’ãƒªã‚»ãƒƒãƒˆ
showEmptyState();
searchInput.value = '';

uploadStatus.innerHTML = `<div class="upload-status upload-success">${newEquipment.length}ä»¶ã®ç¦ç¥‰ç”¨å…·ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ</div>`;

// 3ç§’å¾Œã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ¶ˆå»
setTimeout(() => {
uploadStatus.innerHTML = '';
}, 3000);

} catch (error) {
console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
uploadStatus.innerHTML = `<div class="upload-status upload-error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;

setTimeout(() => {
uploadStatus.innerHTML = '';
}, 5000);
}
});

// æ¤œç´¢æ©Ÿèƒ½
searchInput.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase().trim();

    if (welfareEquipment.length === 0) {
        showNoDataState();
        return;
    }

    if (query === '') {
        showEmptySearchState();
        return;
    }

    filteredItems = welfareEquipment.filter(item => 
        item.name.toLowerCase().includes(query)
    );

    displaySearchResults(filteredItems);
});

function showEmptyState() {
    if (welfareEquipment.length === 0) {
        showNoDataState();
    } else {
        showEmptySearchState();
    }
}

function displaySearchResults(items) {
if (items.length === 0) {
searchResults.innerHTML = `
<div class="empty-state">
<h3>è©²å½“ã™ã‚‹å“ç›®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h3>
<p>åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã—ã¦ã¿ã¦ãã ã•ã„</p>
</div>
`;
return;
}

searchResults.innerHTML = items.map(item => {
const isSelected = selectedItems.some(selected => selected.id === item.id);
return `
<div class="result-item">
<div class="item-info">
<div class="item-name">${item.name}</div>
<div class="item-points">${item.points}ç‚¹/æœˆ</div>
</div>
<button class="add-btn" onclick="addItem(${item.id})" ${isSelected ? 'disabled' : ''}>
${isSelected ? 'è¿½åŠ æ¸ˆã¿' : 'è¿½åŠ '}
</button>
</div>
`;
}).join('');
}

function addItem(itemId) {
const item = welfareEquipment.find(item => item.id === itemId);
if (item && !selectedItems.some(selected => selected.id === itemId)) {
selectedItems.push(item);
updateCalculator();
updateMobileCount();
// æ¤œç´¢çµæœã‚’æ›´æ–°ã—ã¦ã€Œè¿½åŠ æ¸ˆã¿ã€çŠ¶æ…‹ã‚’åæ˜ 
displaySearchResults(filteredItems);
}
}

function removeItem(itemId) {
selectedItems = selectedItems.filter(item => item.id !== itemId);
updateCalculator();
updateMobileCount();
// æ¤œç´¢çµæœã‚’æ›´æ–°ã—ã¦ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’åæ˜ 
displaySearchResults(filteredItems);
}

function updateCalculator() {
const totalPoints = selectedItems.reduce((sum, item) => sum + item.points, 0);
totalPointsElement.textContent = `${totalPoints}ç‚¹`;

if (selectedItems.length === 0) {
selectedItemsContainer.innerHTML = `
<div class="empty-state">
<p>é¸æŠã•ã‚ŒãŸå“ç›®ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
</div>
`;
} else {
selectedItemsContainer.innerHTML = selectedItems.map(item => `
<div class="selected-item">
<div class="selected-item-info">
<div class="selected-item-name">${item.name}</div>
<div class="selected-item-points">${item.points}ç‚¹/æœˆ</div>
</div>
<button class="remove-btn" onclick="removeItem(${item.id})">Ã—</button>
</div>
`).join('');
}
}

function updateMobileCount() {
mobileCountSpan.textContent = selectedItems.length;
}

clearAllBtn.addEventListener('click', () => {
selectedItems = [];
updateCalculator();
updateMobileCount();
displaySearchResults(filteredItems);
});

// ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®è¨ˆç®—æ©Ÿè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
toggleCalculatorBtn.addEventListener('click', () => {
calculator.classList.add('show');
closeCalculatorBtn.style.display = 'block';
});

closeCalculatorBtn.addEventListener('click', () => {
calculator.classList.remove('show');
closeCalculatorBtn.style.display = 'none';
});

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
initializeApp();

// å…±æœ‰æ©Ÿèƒ½ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
generateShareCodeBtn.addEventListener('click', async () => {
    if (welfareEquipment.length === 0) return;
    
    generateShareCodeBtn.disabled = true;
    generateShareCodeBtn.textContent = 'ç”Ÿæˆä¸­...';
    
    const result = shareDataLocal(welfareEquipment);
    
    if (result.success) {
        shareCodeDisplay.innerHTML = `
            <div class="share-code">${result.shareCode}</div>
            <div class="share-code-info">
                ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ä»–ã®ç«¯æœ«ã§å…¥åŠ›ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ã§ãã¾ã™<br>
                <small>â€»ã“ã®ãƒ‡ãƒ¢ç‰ˆã§ã¯ãƒ–ãƒ©ã‚¦ã‚¶é–“ã§ã®å…±æœ‰ã¯ã§ãã¾ã›ã‚“</small>
            </div>
            <button class="copy-btn" onclick="copyToClipboard('${result.shareCode}')">
                ğŸ“‹ ã‚³ãƒ”ãƒ¼
            </button>
        `;
        shareCodeDisplay.classList.remove('hidden');
    } else {
        alert('å…±æœ‰ã‚³ãƒ¼ãƒ‰ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
    }
    
    generateShareCodeBtn.disabled = false;
    generateShareCodeBtn.textContent = 'ğŸ“¤ å…±æœ‰ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ';
});

loadFromCodeBtn.addEventListener('click', () => {
    loadCodeInput.classList.remove('hidden');
    shareCodeDisplay.classList.add('hidden');
});

cancelLoadBtn.addEventListener('click', () => {
    loadCodeInput.classList.add('hidden');
    shareCodeInput.value = '';
});

loadDataBtn.addEventListener('click', () => {
    const code = shareCodeInput.value.trim().toUpperCase();
    if (!code) {
        alert('å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    const result = loadDataFromCode(code);
    
    if (result.success) {
        welfareEquipment = result.data;
        filteredItems = welfareEquipment;
        saveData(welfareEquipment);
        
        selectedItems = [];
        updateCalculator();
        updateMobileCount();
        updateShareButton();
        showEmptySearchState();
        searchInput.value = '';
        
        const loadDate = new Date(result.timestamp).toLocaleString('ja-JP');
        showDataStatus(`å…±æœ‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ${welfareEquipment.length}ä»¶ã€${loadDate}ï¼‰`);
        
        loadCodeInput.classList.add('hidden');
        shareCodeInput.value = '';
    } else {
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
    }
});

// ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
function copyToClipboard(text) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
            alert('ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
        }).catch(() => {
            fallbackCopyTextToClipboard(text);
        });
    } else {
        fallbackCopyTextToClipboard(text);
    }
}

function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.top = '0';
    textArea.style.left = '0';
    textArea.style.position = 'fixed';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        alert('ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
    } catch (err) {
        alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + text);
    }
    
    document.body.removeChild(textArea);
}

// PWAç”¨ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ç™»éŒ²
if ('serviceWorker' in navigator) {
window.addEventListener('load', () => {
navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4gewogIGV2ZW50LndhaXRVbnRpbChzZWxmLnNraXBXYWl0aW5nKCkpOwp9KTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignZmV0Y2gnLCBldmVudCA9PiB7CiAgZXZlbnQucmVzcG9uZFdpdGgoZmV0Y2goZXZlbnQucmVxdWVzdCkpOwp9KTs=')
.then((registration) => {
console.log('SW registered: ', registration);
})
.catch((registrationError) => {
console.log('SW registration failed: ', registrationError);
});
});
}
</script>
</body>
</html>
